<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outrigger SEO Audit Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-card-hover: #1c2128;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-purple: #a855f7;
            --accent-purple-hover: #9333ea;
            --accent-cyan: #22d3ee;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
        }
        body { background-color: var(--bg-dark); color: var(--text-primary); }
        .bg-dark { background-color: var(--bg-dark); }
        .bg-card { background-color: var(--bg-card); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-cyan); }
        .border-card { border-color: var(--border-color); }
        .tab-active { background-color: var(--accent-purple); color: white; }
        .tab-inactive { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .tab-inactive:hover { background-color: var(--bg-card-hover); color: var(--text-primary); }
        .btn-primary { background-color: var(--accent-purple); }
        .btn-primary:hover { background-color: var(--accent-purple-hover); }
        .btn-cyan { background-color: var(--accent-cyan); color: var(--bg-dark); }
        .btn-cyan:hover { background-color: #06b6d4; }
        .btn-green { background-color: var(--accent-green); color: var(--bg-dark); }
        .btn-green:hover { background-color: #16a34a; }
        .btn-orange { background-color: var(--accent-orange); color: white; }
        .btn-orange:hover { background-color: #ea580c; }
        .btn-pink { background-color: var(--accent-pink); color: white; }
        .btn-pink:hover { background-color: #db2777; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); }
        .card:hover { background-color: var(--bg-card-hover); }
        .input-dark { background-color: var(--bg-dark); border-color: var(--border-color); color: var(--text-primary); }
        .input-dark:focus { border-color: var(--accent-purple); outline: none; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.3); }
        .input-dark::placeholder { color: var(--text-secondary); }
        /* Dark theme date picker styling */
        input[type="date"].input-dark {
            color-scheme: dark;
            appearance: none;
            -webkit-appearance: none;
            min-width: 140px;
        }
        input[type="date"].input-dark::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        input[type="date"].input-dark::-webkit-datetime-edit {
            color: var(--text-primary);
        }
        input[type="date"].input-dark::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }
        /* Grid background effect */
        .grid-bg {
            background-image:
                linear-gradient(rgba(48, 54, 61, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(48, 54, 61, 0.3) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>
</head>
<body class="min-h-screen bg-dark grid-bg">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="card rounded-xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-500 to-cyan-400 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-primary">SEO / GEO</h1>
                <p class="text-accent text-lg font-medium">Optimizer</p>
                <p class="text-secondary mt-2 text-sm">Admin Dashboard</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Email</label>
                    <input type="email" id="loginEmail"
                           class="w-full input-dark border rounded-lg px-4 py-3"
                           placeholder="your.name@outrigger.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Password</label>
                    <input type="password" id="loginPassword"
                           class="w-full input-dark border rounded-lg px-4 py-3"
                           placeholder="Enter password" required>
                </div>
                <div id="loginError" class="text-red-400 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-medium transition">
                    Sign In
                </button>
            </form>

            <p class="text-center text-secondary text-xs mt-6">
                Access restricted to @outrigger.com accounts
            </p>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-cyan-400 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-primary">SEO / GEO <span class="text-accent">Optimizer</span></h1>
                        <p class="text-sm text-secondary">Configure audit rules and brand standards</p>
                    </div>
                </div>
                    <div class="flex items-center gap-2 border-l border-card pl-4">
                    <span id="userEmail" class="text-sm text-secondary"></span>
                    <button onclick="logout()" class="text-secondary hover:text-primary px-3 py-1 rounded text-sm transition">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Site Selector Bar -->
    <div class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex items-center gap-3">
                <label class="text-secondary text-sm">Site:</label>
                <select id="siteSelector" onchange="switchSite()" class="input-dark border rounded-lg px-3 py-1.5 text-sm min-w-[200px]">
                    <option value="">Loading sites...</option>
                </select>
                <button onclick="openAddSiteModal()" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add Site
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex gap-2">
                <button onclick="showTab('seo')" id="tab-seo" class="px-5 py-2 font-medium transition-all tab-active rounded-lg text-sm">
                    SEO/GEO Rules
                </button>
                <button onclick="showTab('voice')" id="tab-voice" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Voice &amp; Tone
                </button>
                <button onclick="showTab('brand')" id="tab-brand" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Brand Standards
                </button>
                <button onclick="showTab('logs')" id="tab-logs" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Audit Logs
                </button>

                <!-- Right-aligned controls -->
                <div class="ml-auto flex items-center gap-4">
                    <!-- Last Run Status -->
                    <div id="lastRunStatus" class="flex items-center gap-2 text-sm">
                        <span class="text-secondary">Last run:</span>
                        <span id="lastRunTime" class="text-primary">Loading...</span>
                    </div>
                    <!-- Run Audit Button -->
                    <button onclick="runAuditNow()" id="runAuditBtn" class="btn-primary px-4 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Run
                    </button>
                    <!-- Settings Gear -->
                    <button onclick="showTab('settings')" class="p-2 rounded-lg text-secondary hover:text-primary hover:bg-card-hover transition" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <!-- Connection Status (small indicator) -->
                    <div id="connectionStatus" class="flex items-center gap-1 text-xs text-secondary" title="Firestore connection">
                        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- SEO/GEO Rules Tab -->
        <div id="panel-seo" class="tab-panel">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">SEO/GEO Check Rules</h2>
                    <button onclick="addSeoRule()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Rule
                    </button>
                </div>
                <div id="seoRulesList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading rules...</p>
                </div>
            </div>
        </div>

        <!-- Voice & Tone Tab -->
        <div id="panel-voice" class="tab-panel hidden">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Voice &amp; Tone Guidelines</h2>
                    <button onclick="addVoiceRule()" class="btn-green text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Guideline
                    </button>
                </div>
                <div id="voiceRulesList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading guidelines...</p>
                </div>
            </div>
        </div>

        <!-- Brand Standards Tab -->
        <div id="panel-brand" class="tab-panel hidden">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Brand Standards</h2>
                    <button onclick="addBrandStandard()" class="btn-orange text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Standard
                    </button>
                </div>
                <div id="brandStandardsList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading standards...</p>
                </div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="panel-logs" class="tab-panel hidden">
            <div class="card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Audit Run History</h2>
                    <div class="flex items-center gap-3">
                        <!-- Date Range Filter -->
                        <div class="flex items-center gap-2">
                            <select id="dateRangeFilter" onchange="handleDateRangeChange()" class="input-dark border rounded-lg px-3 py-2 text-sm">
                                <option value="30">Last 30 days</option>
                                <option value="60">Last 60 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="180">Last 6 months</option>
                                <option value="365">Last 12 months</option>
                                <option value="ytd">Year to date</option>
                                <option value="custom">Custom range</option>
                            </select>
                        </div>
                        <!-- Custom Date Range (hidden by default) -->
                        <div id="customDateRange" class="hidden flex items-center gap-2">
                            <div class="relative">
                                <input type="date" id="dateFrom" class="input-dark border rounded-lg px-3 py-2 text-sm pr-8 cursor-pointer" onchange="loadAuditLogs()">
                                <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-secondary pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <span class="text-secondary">to</span>
                            <div class="relative">
                                <input type="date" id="dateTo" class="input-dark border rounded-lg px-3 py-2 text-sm pr-8 cursor-pointer" onchange="loadAuditLogs()">
                                <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-secondary pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                        </div>
                        <button onclick="loadAuditLogs()" class="btn-cyan px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <div id="auditLogsList" class="space-y-4">
                    <p class="text-secondary text-center py-8">Loading audit logs...</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="panel-settings" class="tab-panel hidden">
            <!-- Connection Status Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Connection Status
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-primary font-medium">Firestore Database</p>
                                    <p class="text-secondary text-sm">Cloud database for rules & logs</p>
                                </div>
                            </div>
                            <div id="firestoreStatus" class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                                <span class="text-secondary text-sm">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-primary font-medium">Monday.com</p>
                                    <p class="text-secondary text-sm">Task management integration</p>
                                </div>
                            </div>
                            <div id="mondayStatus" class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <span class="text-secondary text-sm">Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Configuration Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                    </svg>
                    Audit Configuration
                </h2>
                <div class="space-y-4">
                    <!-- Sitemap URL -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Sitemap URL</label>
                        <div class="flex gap-2">
                            <input type="url" id="configSitemapUrl" class="flex-1 input-dark border rounded-lg px-4 py-2"
                                   value="https://www.outrigger.com/sitemap.xml" placeholder="https://example.com/sitemap.xml">
                            <button onclick="testSitemapUrl()" class="btn-cyan px-4 py-2 rounded-lg text-sm font-medium">Test</button>
                        </div>
                        <p class="text-xs text-secondary mt-1">The sitemap used to discover pages for auditing</p>
                    </div>

                    <!-- Days to Check -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Pages Modified Within (days)</label>
                        <input type="number" id="configDaysToCheck" class="w-32 input-dark border rounded-lg px-4 py-2"
                               value="7" min="1" max="365">
                        <p class="text-xs text-secondary mt-1">Only audit pages modified within this timeframe</p>
                    </div>

                    <!-- Max Pages Per Audit -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Max Pages Per Audit</label>
                        <select id="configMaxPages" class="input-dark border rounded-lg px-4 py-2">
                            <option value="1">1 (Testing)</option>
                            <option value="5">5 pages</option>
                            <option value="10">10 pages</option>
                            <option value="25">25 pages</option>
                            <option value="50">50 pages</option>
                            <option value="100">100 pages</option>
                            <option value="0">Unlimited</option>
                        </select>
                        <p class="text-xs text-secondary mt-1">Limit pages per audit run to control API costs</p>
                    </div>
                </div>
            </div>

            <!-- LLM Settings Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI / LLM Settings
                </h2>
                <div class="space-y-4">
                    <!-- AI Model -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">AI Model</label>
                        <select id="configAiModel" class="input-dark border rounded-lg px-4 py-2">
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Faster/Cheaper)</option>
                        </select>
                        <p class="text-xs text-secondary mt-1">Model used for voice/tone and brand compliance checks</p>
                    </div>

                    <!-- Max Rules Per Batch -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Rules Per LLM Batch</label>
                        <input type="number" id="configRulesPerBatch" class="w-32 input-dark border rounded-lg px-4 py-2"
                               value="5" min="1" max="20">
                        <p class="text-xs text-secondary mt-1">Number of rules to evaluate per API call (lower = more accurate, higher = faster)</p>
                    </div>

                    <!-- Enable/Disable LLM Auditing -->
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="configEnableLLM" class="w-5 h-5 rounded bg-dark border-card accent-purple-500" checked>
                        <div>
                            <label for="configEnableLLM" class="text-primary font-medium cursor-pointer">Enable AI-Powered Auditing</label>
                            <p class="text-xs text-secondary">Voice/tone and brand compliance checks use Claude AI</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card rounded-xl p-6 border-red-500/30">
                <h2 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Danger Zone
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-dark rounded-lg border border-red-500/20">
                        <div>
                            <p class="text-primary font-medium">Clear All Audit Logs</p>
                            <p class="text-secondary text-sm">Permanently delete all audit history from Firestore</p>
                        </div>
                        <button onclick="confirmClearLogs()" class="px-4 py-2 rounded-lg border border-red-500 text-red-400 hover:bg-red-500/10 transition text-sm font-medium">
                            Clear Logs
                        </button>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-dark rounded-lg border border-red-500/20">
                        <div>
                            <p class="text-primary font-medium">Reset All Rules to Defaults</p>
                            <p class="text-secondary text-sm">Replace all SEO, voice, and brand rules with defaults</p>
                        </div>
                        <button onclick="confirmResetRules()" class="px-4 py-2 rounded-lg border border-red-500 text-red-400 hover:bg-red-500/10 transition text-sm font-medium">
                            Reset Rules
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Settings Button -->
            <div class="mt-6 flex justify-end">
                <button onclick="saveSettings()" class="btn-primary px-6 py-3 rounded-lg font-medium flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Settings
                </button>
            </div>
        </div>
    </main>
    </div><!-- End mainApp -->

    <!-- Modal for Adding/Editing -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 id="modalTitle" class="text-xl font-bold text-primary mb-4">Add Rule</h3>
                <form id="modalForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Name</label>
                        <input type="text" id="formName" class="w-full input-dark border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Description <span class="text-secondary/60 font-normal">(shown in dashboard)</span></label>
                        <textarea id="formDescription" rows="2" class="w-full input-dark border rounded-lg px-3 py-2" required></textarea>
                    </div>
                    <div id="extraFields"></div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="formEnabled" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                        <label for="formEnabled" class="text-sm text-secondary">Enabled</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg flex-1 font-medium">Save</button>
                        <button type="button" onclick="closeModal()" class="bg-card border border-card text-secondary hover:text-primary px-6 py-2 rounded-lg transition">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Site Modal for Adding/Editing Sites -->
    <div id="siteModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-lg w-full mx-4">
            <div class="p-6">
                <h3 id="siteModalTitle" class="text-xl font-bold text-primary mb-4">Add Site</h3>
                <form id="siteModalForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Site Name</label>
                        <input type="text" id="siteName" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., Outrigger Hotels" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Site ID (URL-safe, no spaces)</label>
                        <input type="text" id="siteId" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., outrigger" pattern="[a-z0-9-]+" required>
                        <p class="text-xs text-secondary mt-1">Lowercase letters, numbers, and hyphens only</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Domain</label>
                        <input type="text" id="siteDomain" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., outrigger.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Sitemap URL</label>
                        <input type="url" id="siteSitemapUrl" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="https://www.example.com/sitemap.xml" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Monday.com Board ID</label>
                        <input type="text" id="siteMondayBoardId" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., 18395774522">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Days to Check</label>
                            <input type="number" id="siteDaysToCheck" class="w-full input-dark border rounded-lg px-3 py-2" value="7" min="1" max="90">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Max Pages</label>
                            <input type="number" id="siteMaxPages" class="w-full input-dark border rounded-lg px-3 py-2" value="10" min="1" max="100">
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="siteEnableLLM" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                            <label for="siteEnableLLM" class="text-sm text-secondary">Enable LLM Audits</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="siteEnabled" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                            <label for="siteEnabled" class="text-sm text-secondary">Site Enabled</label>
                        </div>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg flex-1 font-medium">Save Site</button>
                        <button type="button" onclick="closeSiteModal()" class="bg-card border border-card text-secondary hover:text-primary px-6 py-2 rounded-lg transition">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============ AUTHENTICATION ============
        const AUTH_COOKIE_NAME = 'outrigger_auth';
        const AUTH_COOKIE_DAYS = 30;
        const VALID_PASSWORD = 'outrigger2026';
        const VALID_DOMAIN = '@outrigger.com';

        // Cookie helpers
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/;SameSite=Strict';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/';
        }

        // Check authentication on page load
        function checkAuth() {
            const authData = getCookie(AUTH_COOKIE_NAME);
            if (authData) {
                try {
                    const { email, expires } = JSON.parse(authData);
                    if (email && email.toLowerCase().endsWith(VALID_DOMAIN) && new Date(expires) > new Date()) {
                        showApp(email);
                        return true;
                    }
                } catch (e) {
                    console.error('Invalid auth cookie');
                }
            }
            showLogin();
            return false;
        }

        // Show login screen
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Show main app
        function showApp(email) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = email;
            // Load sites first, then data will load when site is selected
            loadSites();
            // Small delay to ensure site selector has loaded
            setTimeout(function() {
                loadAllData();
                loadLastRunTime();
            }, 500);
        }

        // Cloud Run API URL
        const API_URL = 'https://outrigger-seo-audit-22338575803.us-central1.run.app';

        // Load last run time from Firestore (site-specific)
        function loadLastRunTime() {
            getSiteCollection('auditLogs').orderBy('timestamp', 'desc').limit(1).get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        document.getElementById('lastRunTime').textContent = 'Never';
                    } else {
                        var lastLog = snapshot.docs[0].data();
                        if (lastLog.timestamp) {
                            var date = lastLog.timestamp.toDate();
                            var timeAgo = getTimeAgo(date);
                            document.getElementById('lastRunTime').textContent = timeAgo;
                            document.getElementById('lastRunTime').title = date.toLocaleString();
                        } else {
                            document.getElementById('lastRunTime').textContent = 'Unknown';
                        }
                    }
                })
                .catch(function(error) {
                    console.error('Error loading last run time:', error);
                    document.getElementById('lastRunTime').textContent = 'Error';
                });
        }

        // Get human-readable time ago string
        function getTimeAgo(date) {
            var seconds = Math.floor((new Date() - date) / 1000);
            var interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + ' year' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + ' month' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + ' day' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + ' hour' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + ' minute' + (interval > 1 ? 's' : '') + ' ago';
            return 'Just now';
        }

        // Run audit now
        function runAuditNow() {
            var btn = document.getElementById('runAuditBtn');
            var originalContent = btn.innerHTML;

            // Update button to show loading state
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Running...';
            btn.classList.add('opacity-75');

            // Make POST request to trigger audit for current site
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ site_id: currentSiteId })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('Audit completed:', data);

                // Show success message
                if (data.status === 'success') {
                    var results = data.results;
                    alert('Audit completed!\n\n' +
                          'Pages audited: ' + results.pages + '\n' +
                          'Issues found: ' + results.issues + '\n' +
                          'Tasks created: ' + results.tasks_created + '\n' +
                          'Duplicates skipped: ' + results.duplicates_skipped);

                    // Refresh last run time and logs
                    loadLastRunTime();
                    if (currentTab === 'logs') {
                        loadAuditLogs();
                    }
                } else {
                    alert('Audit completed with status: ' + data.status);
                }
            })
            .catch(function(error) {
                console.error('Error running audit:', error);
                alert('Error running audit: ' + error.message);
            })
            .finally(function() {
                // Restore button
                btn.disabled = false;
                btn.innerHTML = originalContent;
                btn.classList.remove('opacity-75');
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            // Validate email domain
            if (!email.endsWith(VALID_DOMAIN)) {
                errorEl.textContent = 'Access restricted to @outrigger.com email addresses';
                errorEl.classList.remove('hidden');
                return;
            }

            // Validate password
            if (password !== VALID_PASSWORD) {
                errorEl.textContent = 'Invalid password';
                errorEl.classList.remove('hidden');
                return;
            }

            // Success - set cookie for 30 days
            const expires = new Date();
            expires.setTime(expires.getTime() + (AUTH_COOKIE_DAYS * 24 * 60 * 60 * 1000));
            const authData = JSON.stringify({ email: email, expires: expires.toISOString() });
            setCookie(AUTH_COOKIE_NAME, authData, AUTH_COOKIE_DAYS);

            errorEl.classList.add('hidden');
            showApp(email);
        }

        // Logout
        function logout() {
            deleteCookie(AUTH_COOKIE_NAME);
            showLogin();
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Attach login form handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            checkAuth();
        });

        // ============ FIREBASE & APP CODE ============

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDu4Ka6oFSUOH_7PAZW7k9-2u46SlmbBWE",
            authDomain: "project-85d26db5-f70f-487e-b0e.firebaseapp.com",
            projectId: "project-85d26db5-f70f-487e-b0e",
            storageBucket: "project-85d26db5-f70f-487e-b0e.firebasestorage.app",
            messagingSenderId: "22338575803",
            appId: "1:22338575803:web:58fef3f290892f25c5f89e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // State
        let currentTab = 'seo';
        let currentEditId = null;
        let currentCollection = null;
        let currentSiteId = localStorage.getItem('selectedSite') || null;
        let sites = [];
        let editingSiteId = null;

        // ============ SITE MANAGEMENT ============

        // Load all sites for dropdown
        function loadSites() {
            var selector = document.getElementById('siteSelector');
            selector.innerHTML = '<option value="">Loading...</option>';

            db.collection('sites').get()
                .then(function(snapshot) {
                    sites = [];
                    var optionsHtml = '';

                    if (snapshot.empty) {
                        optionsHtml = '<option value="">No sites configured</option>';
                    } else {
                        snapshot.forEach(function(doc) {
                            var siteId = doc.id;
                            // Get the config subcollection for this site
                            db.collection('sites').doc(siteId).collection('config').doc('settings').get()
                                .then(function(configDoc) {
                                    if (configDoc.exists) {
                                        var config = configDoc.to_dict ? configDoc.to_dict() : configDoc.data();
                                        sites.push({ id: siteId, ...config });
                                        updateSiteSelector();
                                    }
                                });
                        });
                        // Initial update with site IDs while configs load
                        snapshot.forEach(function(doc) {
                            optionsHtml += '<option value="' + doc.id + '">' + doc.id + '</option>';
                        });
                    }

                    selector.innerHTML = optionsHtml;

                    // Select saved site or first available
                    if (currentSiteId && selector.querySelector('option[value="' + currentSiteId + '"]')) {
                        selector.value = currentSiteId;
                    } else if (snapshot.size > 0) {
                        currentSiteId = snapshot.docs[0].id;
                        selector.value = currentSiteId;
                        localStorage.setItem('selectedSite', currentSiteId);
                    }
                })
                .catch(function(error) {
                    console.error('Error loading sites:', error);
                    selector.innerHTML = '<option value="">Error loading sites</option>';
                });
        }

        // Update site selector with full names
        function updateSiteSelector() {
            var selector = document.getElementById('siteSelector');
            var optionsHtml = '';
            sites.forEach(function(site) {
                var selected = site.id === currentSiteId ? ' selected' : '';
                var displayName = site.name || site.id;
                optionsHtml += '<option value="' + site.id + '"' + selected + '>' + displayName + '</option>';
            });
            if (optionsHtml) {
                selector.innerHTML = optionsHtml;
            }
        }

        // Switch to a different site
        function switchSite() {
            var selector = document.getElementById('siteSelector');
            currentSiteId = selector.value;
            localStorage.setItem('selectedSite', currentSiteId);
            console.log('Switched to site:', currentSiteId);
            loadAllData();
            loadLastRunTime();
        }

        // Open modal to add a new site
        function openAddSiteModal() {
            editingSiteId = null;
            document.getElementById('siteModalTitle').textContent = 'Add New Site';
            document.getElementById('siteId').value = '';
            document.getElementById('siteId').disabled = false;
            document.getElementById('siteName').value = '';
            document.getElementById('siteDomain').value = '';
            document.getElementById('siteSitemapUrl').value = '';
            document.getElementById('siteMondayBoardId').value = '';
            document.getElementById('siteDaysToCheck').value = '7';
            document.getElementById('siteMaxPages').value = '10';
            document.getElementById('siteEnableLLM').checked = true;
            document.getElementById('siteEnabled').checked = true;
            document.getElementById('siteModal').classList.remove('hidden');
            document.getElementById('siteModal').classList.add('flex');
        }

        // Open modal to edit existing site
        function openEditSiteModal(siteId) {
            editingSiteId = siteId;
            document.getElementById('siteModalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = siteId;
            document.getElementById('siteId').disabled = true;

            // Load site config
            db.collection('sites').doc(siteId).collection('config').doc('settings').get()
                .then(function(doc) {
                    if (doc.exists) {
                        var config = doc.data();
                        document.getElementById('siteName').value = config.name || '';
                        document.getElementById('siteDomain').value = config.domain || '';
                        document.getElementById('siteSitemapUrl').value = config.sitemapUrl || '';
                        document.getElementById('siteMondayBoardId').value = config.mondayBoardId || '';
                        document.getElementById('siteDaysToCheck').value = config.daysToCheck || 7;
                        document.getElementById('siteMaxPages').value = config.maxPages || 10;
                        document.getElementById('siteEnableLLM').checked = config.enableLLM !== false;
                        document.getElementById('siteEnabled').checked = config.enabled !== false;
                    }
                    document.getElementById('siteModal').classList.remove('hidden');
                    document.getElementById('siteModal').classList.add('flex');
                });
        }

        // Close site modal
        function closeSiteModal() {
            document.getElementById('siteModal').classList.add('hidden');
            document.getElementById('siteModal').classList.remove('flex');
            editingSiteId = null;
        }

        // Save site configuration
        function saveSite(e) {
            e.preventDefault();
            var siteId = editingSiteId || document.getElementById('siteId').value.toLowerCase().replace(/[^a-z0-9-]/g, '-');
            var config = {
                name: document.getElementById('siteName').value,
                domain: document.getElementById('siteDomain').value,
                sitemapUrl: document.getElementById('siteSitemapUrl').value,
                mondayBoardId: document.getElementById('siteMondayBoardId').value,
                daysToCheck: parseInt(document.getElementById('siteDaysToCheck').value) || 7,
                maxPages: parseInt(document.getElementById('siteMaxPages').value) || 10,
                enableLLM: document.getElementById('siteEnableLLM').checked,
                enabled: document.getElementById('siteEnabled').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!editingSiteId) {
                config.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            // First, ensure the parent document exists (required for Firestore queries)
            db.collection('sites').doc(siteId).set({ id: siteId }, { merge: true })
                .then(function() {
                    // Then save the config in the subcollection
                    return db.collection('sites').doc(siteId).collection('config').doc('settings').set(config, { merge: true });
                })
                .then(function() {
                    closeSiteModal();
                    loadSites();
                    if (!editingSiteId) {
                        // Switch to the new site
                        currentSiteId = siteId;
                        localStorage.setItem('selectedSite', siteId);
                    }
                    loadAllData();
                    alert('Site saved successfully!');
                })
                .catch(function(error) {
                    alert('Error saving site: ' + error.message);
                });
        }

        // Get collection reference for current site
        function getSiteCollection(collectionName) {
            if (!currentSiteId) {
                console.warn('No site selected, using legacy collection');
                return db.collection(collectionName);
            }
            return db.collection('sites').doc(currentSiteId).collection(collectionName);
        }

        // Update connection status (header indicator)
        function updateConnectionStatus(connected) {
            var statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400" title="Connected to Firestore"></span>';
            } else {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400" title="Firestore Connection Error"></span>';
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            currentTab = tabName;
            // Visible tabs (settings has no tab button, accessed via gear)
            var visibleTabs = ['seo', 'voice', 'brand', 'logs'];
            var allPanels = ['seo', 'voice', 'brand', 'logs', 'settings'];

            // Update tab button styles
            visibleTabs.forEach(function(tab) {
                var tabBtn = document.getElementById('tab-' + tab);
                if (tab === tabName) {
                    tabBtn.className = 'px-5 py-2 font-medium transition-all tab-active rounded-lg text-sm';
                } else {
                    tabBtn.className = 'px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm';
                }
            });

            // If settings is selected, deactivate all visible tabs
            if (tabName === 'settings') {
                visibleTabs.forEach(function(tab) {
                    document.getElementById('tab-' + tab).className = 'px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm';
                });
            }

            // Show/hide panels
            allPanels.forEach(function(panel) {
                var panelEl = document.getElementById('panel-' + panel);
                if (panel === tabName) {
                    panelEl.classList.remove('hidden');
                } else {
                    panelEl.classList.add('hidden');
                }
            });

            // Load data when switching to specific tabs
            if (tabName === 'logs') {
                loadAuditLogs();
            }
            if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Load SEO Rules (site-specific)
        function loadSeoRules() {
            var container = document.getElementById('seoRulesList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading rules...</p>';

            getSiteCollection('seoRules').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No SEO rules configured for this site. Click "Add Rule" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var rule = doc.data();
                        html += createRuleCard(doc.id, rule, 'seo');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading SEO rules:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading rules. Check console for details.</p>';
                });
        }

        // Load Voice Rules (site-specific)
        function loadVoiceRules() {
            var container = document.getElementById('voiceRulesList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading guidelines...</p>';

            getSiteCollection('voiceRules').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No voice guidelines configured for this site. Click "Add Guideline" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var rule = doc.data();
                        html += createRuleCard(doc.id, rule, 'voice');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading voice rules:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading guidelines. Check console for details.</p>';
                });
        }

        // Load Brand Standards (site-specific)
        function loadBrandStandards() {
            var container = document.getElementById('brandStandardsList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading standards...</p>';

            getSiteCollection('brandStandards').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No brand standards configured for this site. Click "Add Standard" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var standard = doc.data();
                        html += createRuleCard(doc.id, standard, 'brand');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading brand standards:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading standards. Check console for details.</p>';
                });
        }

        // Handle date range filter change
        function handleDateRangeChange() {
            var filterValue = document.getElementById('dateRangeFilter').value;
            var customRangeEl = document.getElementById('customDateRange');

            if (filterValue === 'custom') {
                customRangeEl.classList.remove('hidden');
                // Set default custom dates (last 30 days)
                var today = new Date();
                var thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            } else {
                customRangeEl.classList.add('hidden');
            }
            loadAuditLogs();
        }

        // Get date range based on filter selection
        function getDateRange() {
            var filterValue = document.getElementById('dateRangeFilter').value;
            var endDate = new Date();
            var startDate = new Date();

            if (filterValue === 'custom') {
                var fromInput = document.getElementById('dateFrom').value;
                var toInput = document.getElementById('dateTo').value;
                if (fromInput && toInput) {
                    startDate = new Date(fromInput);
                    endDate = new Date(toInput);
                    endDate.setHours(23, 59, 59, 999); // End of day
                } else {
                    startDate.setDate(endDate.getDate() - 30);
                }
            } else if (filterValue === 'ytd') {
                startDate = new Date(endDate.getFullYear(), 0, 1); // January 1st
            } else {
                var days = parseInt(filterValue);
                startDate.setDate(endDate.getDate() - days);
            }

            return { startDate: startDate, endDate: endDate };
        }

        // Load Audit Logs (site-specific)
        function loadAuditLogs() {
            var container = document.getElementById('auditLogsList');
            container.innerHTML = '<p class="text-secondary text-center py-8">Loading audit logs...</p>';

            var dateRange = getDateRange();

            getSiteCollection('auditLogs')
                .where('timestamp', '>=', dateRange.startDate)
                .where('timestamp', '<=', dateRange.endDate)
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-secondary text-center py-8">No audit logs found for this site in the selected date range.</p>';
                        return;
                    }
                    var html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                    snapshot.forEach(function(doc) {
                        var log = doc.data();
                        html += createLogCard(doc.id, log);
                    });
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading audit logs:', error);
                    container.innerHTML = '<p class="text-red-400 text-center py-8">Error loading logs. Check console for details.</p>';
                });
        }

        // Store audit logs for CSV download
        var auditLogsCache = {};

        // Create audit log card HTML (matching the design from screenshot)
        function createLogCard(id, log) {
            // Cache the log for CSV download
            auditLogsCache[id] = log;

            var timestamp = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'Unknown';
            var pagesAudited = log.pagesAudited || 0;
            var totalIssues = log.totalIssues || 0;
            var tasksCreated = log.tasksCreated || 0;
            var duplicatesSkipped = log.duplicatesSkipped || 0;

            // Calculate completion percentage (tasks created / total issues)
            var completionPct = totalIssues > 0 ? Math.round((tasksCreated / totalIssues) * 100) : 100;

            // Issue breakdown
            var seoIssues = log.seoIssues || 0;
            var voiceIssues = log.voiceIssues || 0;
            var brandIssues = log.brandIssues || 0;

            return '<div class="card rounded-xl p-5">' +
                '<div class="flex justify-between items-start mb-4">' +
                    '<div>' +
                        '<h3 class="font-bold text-primary text-lg">Audit Run</h3>' +
                        '<p class="text-secondary text-sm">' + timestamp + '</p>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<span class="text-2xl font-bold text-accent">' + completionPct + '%</span>' +
                        '<p class="text-secondary text-xs">Complete</p>' +
                    '</div>' +
                '</div>' +
                '<div class="space-y-2 mb-4">' +
                    '<div class="flex justify-between text-sm">' +
                        '<span class="text-secondary">Pages Audited</span>' +
                        '<span class="text-primary font-medium">' + pagesAudited + '</span>' +
                    '</div>' +
                    '<div class="flex justify-between text-sm">' +
                        '<span class="text-secondary">Issues Found</span>' +
                        '<span class="text-primary font-medium">' + totalIssues + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="text-xs text-secondary mb-3">Issue Breakdown</div>' +
                '<div class="grid grid-cols-2 gap-2 mb-4">' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-purple-500"></span>' +
                        '<span class="text-secondary text-sm">SEO/GEO</span>' +
                        '<span class="text-primary text-sm ml-auto">' + seoIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-green-500"></span>' +
                        '<span class="text-secondary text-sm">Voice/Tone</span>' +
                        '<span class="text-primary text-sm ml-auto">' + voiceIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-orange-500"></span>' +
                        '<span class="text-secondary text-sm">Brand</span>' +
                        '<span class="text-primary text-sm ml-auto">' + brandIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-gray-500"></span>' +
                        '<span class="text-secondary text-sm">Duplicates</span>' +
                        '<span class="text-primary text-sm ml-auto">' + duplicatesSkipped + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="space-y-2 mb-4">' +
                    '<div>' +
                        '<div class="flex justify-between text-xs mb-1">' +
                            '<span class="text-green-400">Tasks Created</span>' +
                            '<span class="text-green-400">' + Math.round((tasksCreated / Math.max(totalIssues, 1)) * 100) + '%</span>' +
                        '</div>' +
                        '<div class="h-2 bg-dark rounded-full overflow-hidden">' +
                            '<div class="h-full bg-green-500 rounded-full" style="width: ' + Math.round((tasksCreated / Math.max(totalIssues, 1)) * 100) + '%"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                (log.issues && log.issues.length > 0 ?
                    '<div class="text-xs text-secondary mb-3 flex items-center gap-1">' +
                        '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>' +
                        '</svg>' +
                        log.issues.length + ' issue records stored' +
                    '</div>'
                : '<div class="text-xs text-secondary mb-3 opacity-50">No issue records (older audit)</div>') +
                '<button onclick="downloadLogCSV(\'' + id + '\')" class="w-full btn-cyan py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition">' +
                    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>' +
                    '</svg>' +
                    'Download CSV' +
                '</button>' +
            '</div>';
        }

        // Download audit log as CSV
        function downloadLogCSV(logId) {
            var log = auditLogsCache[logId];
            if (!log) {
                alert('Log data not found');
                return;
            }

            var timestamp = log.timestamp ? new Date(log.timestamp.toDate()) : new Date();
            var dateStr = timestamp.toISOString().split('T')[0];

            // Create CSV content - Summary Section
            var csvContent = '=== AUDIT SUMMARY ===\n';
            csvContent += 'Metric,Value\n';
            csvContent += 'Audit Date,' + timestamp.toLocaleString() + '\n';
            csvContent += 'Pages Audited,' + (log.pagesAudited || 0) + '\n';
            csvContent += 'Total Issues,' + (log.totalIssues || 0) + '\n';
            csvContent += 'Tasks Created,' + (log.tasksCreated || 0) + '\n';
            csvContent += 'Duplicates Skipped,' + (log.duplicatesSkipped || 0) + '\n';
            csvContent += 'SEO/GEO Issues,' + (log.seoIssues || 0) + '\n';
            csvContent += 'Voice/Tone Issues,' + (log.voiceIssues || 0) + '\n';
            csvContent += 'Brand Issues,' + (log.brandIssues || 0) + '\n';

            // Add rules used if available
            if (log.rulesUsed) {
                csvContent += '\n=== RULES USED ===\n';
                csvContent += 'Rule Type,Count\n';
                csvContent += 'SEO Rules,' + (log.rulesUsed.seo || 0) + '\n';
                csvContent += 'Voice Rules,' + (log.rulesUsed.voice || 0) + '\n';
                csvContent += 'Brand Rules,' + (log.rulesUsed.brand || 0) + '\n';
            }

            // Add individual issues if available
            if (log.issues && log.issues.length > 0) {
                csvContent += '\n=== ALL ISSUES LOGGED TO MONDAY.COM ===\n';
                csvContent += 'URL,Issue Title,Category,Severity,Type,Monday Status,Rule Name,Description\n';

                log.issues.forEach(function(issue) {
                    // Escape fields that might contain commas or quotes
                    var escapeField = function(field) {
                        if (!field) return '';
                        var str = String(field);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    };

                    csvContent += escapeField(issue.url) + ',';
                    csvContent += escapeField(issue.title) + ',';
                    csvContent += escapeField(issue.category) + ',';
                    csvContent += escapeField(issue.severity) + ',';
                    csvContent += escapeField(issue.type) + ',';
                    csvContent += escapeField(issue.monday_status) + ',';
                    csvContent += escapeField(issue.rule_name) + ',';
                    csvContent += escapeField(issue.description) + '\n';
                });
            }

            // Create and trigger download
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'audit-log-' + dateStr + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Create rule card HTML
        function createRuleCard(id, data, type) {
            var statusClass = data.enabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400';
            var statusText = data.enabled ? 'Enabled' : 'Disabled';
            var borderColor = type === 'seo' ? 'border-l-purple-500' : (type === 'voice' ? 'border-l-green-500' : 'border-l-orange-500');

            // Badge for LLM-powered rules
            var llmBadge = '';
            if (data.prompt) {
                llmBadge = '<span class="px-2 py-1 text-xs rounded-full bg-purple-500/20 text-purple-400">AI-Powered</span>';
            }

            // Severity badge for SEO rules
            var severityBadge = '';
            if (data.severity) {
                var severityClass = {
                    'Critical': 'bg-red-500/20 text-red-400',
                    'High': 'bg-orange-500/20 text-orange-400',
                    'Medium': 'bg-yellow-500/20 text-yellow-400',
                    'Low': 'bg-blue-500/20 text-blue-400'
                }[data.severity] || 'bg-gray-500/20 text-gray-400';
                severityBadge = '<span class="px-2 py-1 text-xs rounded-full ' + severityClass + '">' + data.severity + '</span>';
            }

            return '<div class="card rounded-lg p-4 ' + borderColor + ' border-l-4 hover:bg-card-hover transition-all">' +
                '<div class="flex justify-between items-start">' +
                    '<div class="flex-1">' +
                        '<div class="flex items-center gap-2 mb-2 flex-wrap">' +
                            '<h3 class="font-semibold text-primary">' + escapeHtml(data.name) + '</h3>' +
                            '<span class="px-2 py-1 text-xs rounded-full ' + statusClass + '">' + statusText + '</span>' +
                            severityBadge +
                            llmBadge +
                        '</div>' +
                        '<p class="text-secondary text-sm">' + escapeHtml(data.description) + '</p>' +
                    '</div>' +
                    '<div class="flex gap-2 ml-4">' +
                        '<button onclick="editRule(\'' + type + '\', \'' + id + '\')" class="text-accent hover:bg-card-hover p-2 rounded transition">Edit</button>' +
                        '<button onclick="deleteRule(\'' + type + '\', \'' + id + '\')" class="text-red-400 hover:bg-red-500/10 p-2 rounded transition">Delete</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function openModal(title, collection) {
            currentCollection = collection;
            currentEditId = null;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('formName').value = '';
            document.getElementById('formDescription').value = '';
            document.getElementById('formEnabled').checked = true;
            document.getElementById('extraFields').innerHTML = '';
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            currentEditId = null;
            currentCollection = null;
        }

        // Add functions
        function addSeoRule() {
            openModal('Add SEO/GEO Rule', 'seoRules');
            document.getElementById('extraFields').innerHTML =
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-gray-700 mb-1">Check Type <span class="text-gray-400 font-normal">(identifier)</span></label>' +
                    '<select id="formCheckType" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                        '<option value="title">Title Tag</option>' +
                        '<option value="meta">Meta Description</option>' +
                        '<option value="h1">H1 Heading</option>' +
                        '<option value="canonical">Canonical Tag</option>' +
                        '<option value="schema">Schema/Structured Data</option>' +
                        '<option value="content">Content Quality</option>' +
                        '<option value="geo">Geo Meta Tags</option>' +
                        '<option value="og">Open Graph Tags</option>' +
                        '<option value="alt">Image Alt Tags</option>' +
                        '<option value="robots">Robots Meta Tag</option>' +
                        '<option value="custom">Custom (LLM-only)</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>' +
                    '<select id="formSeverity" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                        '<option value="Critical">Critical</option>' +
                        '<option value="High">High</option>' +
                        '<option value="Medium" selected>Medium</option>' +
                        '<option value="Low">Low</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-gray-700 mb-1">LLM Audit Prompt <span class="text-gray-400 font-normal">(optional - enables AI-powered checking)</span></label>' +
                    '<textarea id="formPrompt" rows="6" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent font-mono text-sm" placeholder="Describe what the AI should check for. Example:\n\nCheck if this page has a proper <title> tag. The rule FAILS if:\n1. The page is missing a <title> tag\n2. The title is less than 30 characters\n3. The title is generic like &quot;Home&quot;"></textarea>' +
                    '<p class="text-xs text-gray-500 mt-1">When a prompt is provided, Claude AI will evaluate the page against this rule dynamically. Leave empty to use built-in hardcoded checks.</p>' +
                '</div>';
        }

        function addVoiceRule() {
            openModal('Add Voice Guideline', 'voiceRules');
            document.getElementById('extraFields').innerHTML =
                '<div>' +
                    '<label class="block text-sm font-medium text-gray-700 mb-1">Category</label>' +
                    '<select id="formCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                        '<option value="tone">Tone of Voice</option>' +
                        '<option value="language">Language Style</option>' +
                        '<option value="audience">Target Audience</option>' +
                        '<option value="messaging">Key Messaging</option>' +
                    '</select>' +
                '</div>';
        }

        function addBrandStandard() {
            openModal('Add Brand Standard', 'brandStandards');
            document.getElementById('extraFields').innerHTML =
                '<div>' +
                    '<label class="block text-sm font-medium text-gray-700 mb-1">Standard Type</label>' +
                    '<select id="formStandardType" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                        '<option value="visual">Visual Identity</option>' +
                        '<option value="terminology">Terminology</option>' +
                        '<option value="compliance">Compliance</option>' +
                        '<option value="accessibility">Accessibility</option>' +
                    '</select>' +
                '</div>';
        }

        // Edit rule (site-specific)
        function editRule(type, id) {
            var collectionName = type === 'seo' ? 'seoRules' : (type === 'voice' ? 'voiceRules' : 'brandStandards');
            currentCollection = collectionName;
            currentEditId = id;

            getSiteCollection(collectionName).doc(id).get()
                .then(function(doc) {
                    if (doc.exists) {
                        var data = doc.data();
                        document.getElementById('modalTitle').textContent = 'Edit ' + data.name;
                        document.getElementById('formName').value = data.name || '';
                        document.getElementById('formDescription').value = data.description || '';
                        document.getElementById('formEnabled').checked = data.enabled !== false;

                        // Build extra fields based on type
                        if (type === 'seo') {
                            document.getElementById('extraFields').innerHTML =
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-gray-700 mb-1">Check Type</label>' +
                                    '<select id="formCheckType" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                                        '<option value="title"' + (data.checkType === 'title' ? ' selected' : '') + '>Title Tag</option>' +
                                        '<option value="meta"' + (data.checkType === 'meta' ? ' selected' : '') + '>Meta Description</option>' +
                                        '<option value="h1"' + (data.checkType === 'h1' ? ' selected' : '') + '>H1 Heading</option>' +
                                        '<option value="canonical"' + (data.checkType === 'canonical' ? ' selected' : '') + '>Canonical Tag</option>' +
                                        '<option value="schema"' + (data.checkType === 'schema' ? ' selected' : '') + '>Schema/Structured Data</option>' +
                                        '<option value="content"' + (data.checkType === 'content' ? ' selected' : '') + '>Content Quality</option>' +
                                        '<option value="geo"' + (data.checkType === 'geo' ? ' selected' : '') + '>Geo Meta Tags</option>' +
                                        '<option value="og"' + (data.checkType === 'og' ? ' selected' : '') + '>Open Graph Tags</option>' +
                                        '<option value="alt"' + (data.checkType === 'alt' ? ' selected' : '') + '>Image Alt Tags</option>' +
                                        '<option value="robots"' + (data.checkType === 'robots' ? ' selected' : '') + '>Robots Meta Tag</option>' +
                                        '<option value="custom"' + (data.checkType === 'custom' ? ' selected' : '') + '>Custom (LLM-only)</option>' +
                                    '</select>' +
                                '</div>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>' +
                                    '<select id="formSeverity" class="w-full border border-gray-300 rounded-lg px-3 py-2">' +
                                        '<option value="Critical"' + (data.severity === 'Critical' ? ' selected' : '') + '>Critical</option>' +
                                        '<option value="High"' + (data.severity === 'High' ? ' selected' : '') + '>High</option>' +
                                        '<option value="Medium"' + (data.severity === 'Medium' || !data.severity ? ' selected' : '') + '>Medium</option>' +
                                        '<option value="Low"' + (data.severity === 'Low' ? ' selected' : '') + '>Low</option>' +
                                    '</select>' +
                                '</div>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-gray-700 mb-1">LLM Audit Prompt <span class="text-gray-400 font-normal">(optional)</span></label>' +
                                    '<textarea id="formPrompt" rows="6" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent font-mono text-sm">' + escapeHtml(data.prompt || '') + '</textarea>' +
                                    '<p class="text-xs text-gray-500 mt-1">When a prompt is provided, Claude AI will evaluate the page against this rule dynamically.</p>' +
                                '</div>';
                        } else {
                            document.getElementById('extraFields').innerHTML = '';
                        }

                        document.getElementById('modal').classList.remove('hidden');
                        document.getElementById('modal').classList.add('flex');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading rule:', error);
                    alert('Error loading rule for editing');
                });
        }

        // Delete rule (site-specific)
        function deleteRule(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            var collectionName = type === 'seo' ? 'seoRules' : (type === 'voice' ? 'voiceRules' : 'brandStandards');

            getSiteCollection(collectionName).doc(id).delete()
                .then(function() {
                    loadAllData();
                })
                .catch(function(error) {
                    console.error('Error deleting:', error);
                    alert('Error deleting item');
                });
        }

        // Form submission
        document.getElementById('modalForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var data = {
                name: document.getElementById('formName').value,
                description: document.getElementById('formDescription').value,
                enabled: document.getElementById('formEnabled').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add extra fields based on collection
            var checkType = document.getElementById('formCheckType');
            var category = document.getElementById('formCategory');
            var standardType = document.getElementById('formStandardType');
            var severity = document.getElementById('formSeverity');
            var prompt = document.getElementById('formPrompt');

            if (checkType) data.checkType = checkType.value;
            if (category) data.category = category.value;
            if (standardType) data.standardType = standardType.value;
            if (severity) data.severity = severity.value;
            if (prompt && prompt.value.trim()) {
                data.prompt = prompt.value.trim();
            }

            var savePromise;
            if (currentEditId) {
                savePromise = getSiteCollection(currentCollection).doc(currentEditId).update(data);
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = getSiteCollection(currentCollection).add(data);
            }

            savePromise
                .then(function() {
                    closeModal();
                    loadAllData();
                })
                .catch(function(error) {
                    console.error('Error saving:', error);
                    alert('Error saving: ' + error.message);
                });
        });

        // Site modal form submission
        document.getElementById('siteModalForm').addEventListener('submit', saveSite);

        // Load all data
        function loadAllData() {
            loadSeoRules();
            loadVoiceRules();
            loadBrandStandards();
        }

        // Seed default rules (run once to populate)
        async function seedDefaultRules() {
            if (!confirm('This will add all recommended SEO/GEO rules with AI-powered prompts. Continue?')) return;

            const seoRules = [
                // TIER 1: CRITICAL - All with LLM prompts
                {
                    name: 'Title Tag Check',
                    checkType: 'title',
                    description: 'Checks for missing or too-short title tags. Title should be 50-60 characters and include primary keywords.',
                    prompt: 'Check if this page has a proper <title> tag. The rule FAILS if:\n1. The page is missing a <title> tag entirely, OR\n2. The title is empty or contains only whitespace, OR\n3. The title is less than 30 characters (too short to be descriptive), OR\n4. The title is generic like "Home" or "Page" without context\n\nFor a hotel/hospitality site, a good title should include the property name, location, and ideally brand.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1
                },
                {
                    name: 'Meta Description Check',
                    checkType: 'meta',
                    description: 'Checks for missing or too-short meta descriptions. Should be 150-160 characters with compelling copy.',
                    prompt: 'Check if this page has a proper meta description. The rule FAILS if:\n1. The page is missing a <meta name="description"> tag, OR\n2. The meta description content is empty, OR\n3. The meta description is less than 120 characters (too short), OR\n4. The meta description is over 160 characters (will be truncated)\n\nFor a hotel site, meta descriptions should be compelling and include a call-to-action.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1
                },
                {
                    name: 'H1 Tag Check',
                    checkType: 'h1',
                    description: 'Checks for missing H1 tags or multiple H1s. Each page should have exactly one H1.',
                    prompt: 'Check if this page has proper H1 heading structure. The rule FAILS if:\n1. The page has NO <h1> tag at all, OR\n2. The page has MORE than one <h1> tag (should have exactly one), OR\n3. The H1 is empty or contains only whitespace\n\nBest practice: Each page should have exactly one H1 that clearly describes the main topic.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1
                },
                {
                    name: 'Canonical Tag Check',
                    checkType: 'canonical',
                    description: 'Checks for missing canonical URLs to prevent duplicate content issues.',
                    prompt: 'Check if this page has a canonical tag. The rule FAILS if:\n1. The page is missing a <link rel="canonical"> tag, OR\n2. The canonical tag exists but has no href value, OR\n3. The canonical href is empty or invalid\n\nA canonical tag tells search engines which version of a page is the "master" copy.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1
                },
                // TIER 2: HIGH PRIORITY
                {
                    name: 'Schema/Structured Data Check',
                    checkType: 'schema',
                    description: 'Comprehensive schema.org checks for Hotel, LocalBusiness, Organization, FAQ schemas. Critical for AI/LLM visibility.',
                    prompt: 'Check if this page has appropriate JSON-LD structured data. The rule FAILS if:\n1. The page has NO <script type="application/ld+json"> tags, OR\n2. For hotel/resort pages: Missing Hotel, LodgingBusiness, or LocalBusiness schema, OR\n3. Schema exists but is missing critical properties like name, address, or description\n\nThis is CRITICAL for AI/LLM visibility - ChatGPT and Google AI pull from structured data.',
                    enabled: true,
                    severity: 'High',
                    tier: 2
                },
                {
                    name: 'Thin Content Check',
                    checkType: 'content',
                    description: 'Flags pages with less than 300 words of content. Thin pages rank poorly.',
                    prompt: 'Analyze the main content (excluding navigation, headers, footers). The rule FAILS if:\n1. The page has less than approximately 300 words of actual content, OR\n2. The content is mostly duplicated/boilerplate text, OR\n3. The main content area appears empty or contains only images without supporting text\n\nFor hotel pages, there should be substantial descriptive content about property features and amenities.',
                    enabled: true,
                    severity: 'High',
                    tier: 2
                },
                {
                    name: 'Geo Meta Tags Check',
                    checkType: 'geo',
                    description: 'Checks for geo.region and geo.placename meta tags for location-based searches.',
                    prompt: 'Check if this page has geographic meta tags. The rule FAILS if:\n1. The page is missing BOTH geo.region and geo.placename meta tags\n\nLook for these tags:\n- <meta name="geo.region" content="US-HI">\n- <meta name="geo.placename" content="Honolulu">\n\nThese help AI travel assistants understand location context.',
                    enabled: true,
                    severity: 'High',
                    tier: 2
                },
                {
                    name: 'Open Graph Tags Check',
                    checkType: 'og',
                    description: 'Checks for og:image, og:title, og:description for social sharing.',
                    prompt: 'Check if this page has proper Open Graph tags. The rule FAILS if:\n1. Missing og:image tag (critical for social engagement), OR\n2. Missing og:title tag, OR\n3. Missing og:description tag\n\nLook for meta tags with property attribute:\n- <meta property="og:image" content="...">\n- <meta property="og:title" content="...">\n- <meta property="og:description" content="...">',
                    enabled: true,
                    severity: 'High',
                    tier: 2
                },
                // TIER 3: MEDIUM
                {
                    name: 'Image Alt Tags Check',
                    checkType: 'alt',
                    description: 'Checks for missing alt text on images for ADA accessibility compliance.',
                    prompt: 'Check if images have proper alt text for accessibility. The rule FAILS if:\n1. Multiple <img> tags are missing the alt attribute, OR\n2. Images have empty alt="" attributes (unless decorative), OR\n3. Alt text is generic like "image" instead of descriptive\n\nNote: A few missing alt tags on decorative images is acceptable. Flag only if there is a significant pattern.',
                    enabled: true,
                    severity: 'Medium',
                    tier: 3
                },
                {
                    name: 'Robots Meta Tag Check',
                    checkType: 'robots',
                    description: 'Checks for presence of robots meta tag to explicitly declare indexing instructions.',
                    prompt: 'Check if this page has a robots meta tag. The rule FAILS if:\n1. The page is missing a <meta name="robots"> tag\n\nThis is a LOW priority check - only flag if completely missing.',
                    enabled: false,
                    severity: 'Low',
                    tier: 3
                },
            ];

            const voiceRules = [
                { name: 'Warm & Welcoming', category: 'tone', description: 'Content should convey genuine Hawaiian hospitality - warm, welcoming, and relaxed. Avoid corporate jargon.', enabled: true },
                { name: 'Adventure & Discovery', category: 'tone', description: 'Inspire a sense of adventure and discovery. Highlight unique experiences and hidden gems.', enabled: true },
                { name: 'Authentic Local Voice', category: 'language', description: 'Use authentic Hawaiian and local terms appropriately (aloha, mahalo, ohana). Include cultural context.', enabled: true },
                { name: 'Sensory Language', category: 'language', description: 'Use vivid sensory language - describe sounds of waves, smell of plumeria, feel of warm sand.', enabled: true },
            ];

            const brandStandards = [
                { name: 'Brand Name Usage', standardType: 'terminology', description: 'Always use "Outrigger" not "OUTRIGGER" or "outrigger". Full name is "Outrigger Hotels & Resorts".', enabled: true },
                { name: 'Property Names', standardType: 'terminology', description: 'Use official property names exactly as registered. Include location identifiers.', enabled: true },
                { name: 'Color Palette', standardType: 'visual', description: 'Primary: Teal (#006272), Gold (#c4a35a), Sunset Orange (#e07c3e). Use consistently.', enabled: true },
                { name: 'Image Standards', standardType: 'visual', description: 'Images should be high-resolution, authentic (not stock), and showcase real guest experiences.', enabled: true },
            ];

            let added = 0;

            // Add SEO rules (or update existing ones with prompts)
            for (const rule of seoRules) {
                const existing = await db.collection('seoRules').where('checkType', '==', rule.checkType).get();
                if (existing.empty) {
                    await db.collection('seoRules').add({ ...rule, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                } else {
                    // Update existing rule with prompt if it doesn't have one
                    const doc = existing.docs[0];
                    const data = doc.data();
                    if (!data.prompt && rule.prompt) {
                        await db.collection('seoRules').doc(doc.id).update({ prompt: rule.prompt });
                        added++;
                    }
                }
            }

            // Add Voice rules
            for (const rule of voiceRules) {
                const existing = await db.collection('voiceRules').where('name', '==', rule.name).get();
                if (existing.empty) {
                    await db.collection('voiceRules').add({ ...rule, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                }
            }

            // Add Brand standards
            for (const standard of brandStandards) {
                const existing = await db.collection('brandStandards').where('name', '==', standard.name).get();
                if (existing.empty) {
                    await db.collection('brandStandards').add({ ...standard, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                }
            }

            alert('Added ' + added + ' new rules/standards. Refreshing...');
            loadAllData();
        }

        // ============ SETTINGS FUNCTIONS ============

        // Load settings from Firestore
        function loadSettings() {
            // Update Firestore connection status
            updateFirestoreStatus();

            // Load saved settings from Firestore
            db.collection('settings').doc('config').get()
                .then(function(doc) {
                    if (doc.exists) {
                        var settings = doc.data();
                        if (settings.sitemapUrl) document.getElementById('configSitemapUrl').value = settings.sitemapUrl;
                        if (settings.daysToCheck) document.getElementById('configDaysToCheck').value = settings.daysToCheck;
                        if (settings.maxPages !== undefined) document.getElementById('configMaxPages').value = settings.maxPages;
                        if (settings.aiModel) document.getElementById('configAiModel').value = settings.aiModel;
                        if (settings.rulesPerBatch) document.getElementById('configRulesPerBatch').value = settings.rulesPerBatch;
                        if (settings.enableLLM !== undefined) document.getElementById('configEnableLLM').checked = settings.enableLLM;
                    }
                })
                .catch(function(error) {
                    console.log('No saved settings found, using defaults');
                });
        }

        // Update Firestore status indicator
        function updateFirestoreStatus() {
            var statusEl = document.getElementById('firestoreStatus');
            db.collection('seoRules').limit(1).get()
                .then(function() {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span><span class="text-green-400 text-sm">Connected</span>';
                })
                .catch(function() {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span><span class="text-red-400 text-sm">Error</span>';
                });
        }

        // Save settings to Firestore
        function saveSettings() {
            var settings = {
                sitemapUrl: document.getElementById('configSitemapUrl').value,
                daysToCheck: parseInt(document.getElementById('configDaysToCheck').value) || 7,
                maxPages: parseInt(document.getElementById('configMaxPages').value) || 0,
                aiModel: document.getElementById('configAiModel').value,
                rulesPerBatch: parseInt(document.getElementById('configRulesPerBatch').value) || 5,
                enableLLM: document.getElementById('configEnableLLM').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('settings').doc('config').set(settings, { merge: true })
                .then(function() {
                    alert('Settings saved successfully!');
                })
                .catch(function(error) {
                    console.error('Error saving settings:', error);
                    alert('Error saving settings: ' + error.message);
                });
        }

        // Test sitemap URL
        function testSitemapUrl() {
            var url = document.getElementById('configSitemapUrl').value;
            if (!url) {
                alert('Please enter a sitemap URL');
                return;
            }

            // Open sitemap in new tab for manual verification
            window.open(url, '_blank');
            alert('Sitemap opened in new tab. Verify it contains valid XML with <url> entries.');
        }

        // Confirm clear logs
        function confirmClearLogs() {
            if (!confirm('Are you sure you want to delete ALL audit logs? This cannot be undone.')) return;
            if (!confirm('This will permanently delete all audit history. Type "DELETE" to confirm.')) return;

            // Get all audit logs and delete them
            db.collection('auditLogs').get()
                .then(function(snapshot) {
                    var batch = db.batch();
                    snapshot.forEach(function(doc) {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(function() {
                    alert('All audit logs have been deleted.');
                    loadAuditLogs();
                })
                .catch(function(error) {
                    console.error('Error deleting logs:', error);
                    alert('Error deleting logs: ' + error.message);
                });
        }

        // Confirm reset rules
        function confirmResetRules() {
            if (!confirm('Are you sure you want to reset ALL rules to defaults? Your custom rules will be lost.')) return;
            if (!confirm('This will replace all SEO, voice, and brand rules. Continue?')) return;

            seedDefaultRules();
        }

        // Note: Initialization is handled by the authentication code at the top of this script
    </script>
</body>
</html>
