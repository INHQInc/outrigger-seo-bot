<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outrigger SEO Audit Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-card-hover: #1c2128;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-purple: #a855f7;
            --accent-purple-hover: #9333ea;
            --accent-cyan: #22d3ee;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
        }
        body { background-color: var(--bg-dark); color: var(--text-primary); }
        .bg-dark { background-color: var(--bg-dark); }
        .bg-card { background-color: var(--bg-card); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-cyan); }
        .border-card { border-color: var(--border-color); }
        .tab-active { background-color: var(--accent-purple); color: white; }
        .tab-inactive { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .tab-inactive:hover { background-color: var(--bg-card-hover); color: var(--text-primary); }
        .btn-primary { background-color: var(--accent-purple); }
        .btn-primary:hover { background-color: var(--accent-purple-hover); }
        .btn-cyan { background-color: var(--accent-cyan); color: var(--bg-dark); }
        .btn-cyan:hover { background-color: #06b6d4; }
        .btn-green { background-color: var(--accent-green); color: var(--bg-dark); }
        .btn-green:hover { background-color: #16a34a; }
        .btn-orange { background-color: var(--accent-orange); color: white; }
        .btn-orange:hover { background-color: #ea580c; }
        .btn-pink { background-color: var(--accent-pink); color: white; }
        .btn-pink:hover { background-color: #db2777; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); }
        .card:hover { background-color: var(--bg-card-hover); }
        .input-dark { background-color: var(--bg-dark); border-color: var(--border-color); color: var(--text-primary); }
        .input-dark:focus { border-color: var(--accent-purple); outline: none; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.3); }
        .input-dark::placeholder { color: var(--text-secondary); }
        /* Dark theme date picker styling */
        input[type="date"].input-dark {
            color-scheme: dark;
            appearance: none;
            -webkit-appearance: none;
            min-width: 140px;
        }
        input[type="date"].input-dark::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        input[type="date"].input-dark::-webkit-datetime-edit {
            color: var(--text-primary);
        }
        input[type="date"].input-dark::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }
        /* Grid background effect */
        .grid-bg {
            background-image:
                linear-gradient(rgba(48, 54, 61, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(48, 54, 61, 0.3) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>
</head>
<body class="min-h-screen bg-dark grid-bg">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="card rounded-xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-500 to-cyan-400 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-primary">SEO / GEO</h1>
                <p class="text-accent text-lg font-medium">Optimizer</p>
                <p class="text-secondary mt-2 text-sm">Admin Dashboard</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Email</label>
                    <input type="email" id="loginEmail"
                           class="w-full input-dark border rounded-lg px-4 py-3"
                           placeholder="your.name@outrigger.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Password</label>
                    <input type="password" id="loginPassword"
                           class="w-full input-dark border rounded-lg px-4 py-3"
                           placeholder="Enter password" required>
                </div>
                <div id="loginError" class="text-red-400 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-medium transition">
                    Sign In
                </button>
            </form>

            <p class="text-center text-secondary text-xs mt-6">
                Access restricted to @outrigger.com accounts
            </p>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-cyan-400 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-primary">SEO / GEO <span class="text-accent">Optimizer</span></h1>
                        <p class="text-sm text-secondary">Configure audit rules and brand standards</p>
                    </div>
                </div>
                    <div class="flex items-center gap-2 border-l border-card pl-4">
                    <span id="userEmail" class="text-sm text-secondary"></span>
                    <button onclick="logout()" class="text-secondary hover:text-primary px-3 py-1 rounded text-sm transition">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Site Selector Bar -->
    <div class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex items-center gap-3">
                <label class="text-secondary text-sm">Site:</label>
                <select id="siteSelector" onchange="switchSite()" class="input-dark border rounded-lg px-3 py-1.5 text-sm min-w-[200px]">
                    <option value="">Loading sites...</option>
                </select>
                <button onclick="openAddSiteModal()" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add Site
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="bg-card border-b border-card">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex gap-2">
                <button onclick="showTab('seo')" id="tab-seo" class="px-5 py-2 font-medium transition-all tab-active rounded-lg text-sm">
                    SEO/GEO Rules
                </button>
                <button onclick="showTab('voice')" id="tab-voice" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Voice &amp; Tone
                </button>
                <button onclick="showTab('brand')" id="tab-brand" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Brand Standards
                </button>
                <button onclick="showTab('logs')" id="tab-logs" class="px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm">
                    Audit Logs
                </button>

                <!-- Right-aligned controls -->
                <div class="ml-auto flex items-center gap-4">
                    <!-- Last Run Status -->
                    <div id="lastRunStatus" class="flex items-center gap-2 text-sm">
                        <span class="text-secondary">Last run:</span>
                        <span id="lastRunTime" class="text-primary">Loading...</span>
                    </div>
                    <!-- Run Audit Button -->
                    <button onclick="openRunAuditModal()" id="runAuditBtn" class="btn-primary px-4 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Run
                    </button>
                    <!-- Settings Gear -->
                    <button onclick="showTab('settings')" class="p-2 rounded-lg text-secondary hover:text-primary hover:bg-card-hover transition" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <!-- Connection Status (small indicator) -->
                    <div id="connectionStatus" class="flex items-center gap-1 text-xs text-secondary" title="Firestore connection">
                        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- SEO/GEO Rules Tab -->
        <div id="panel-seo" class="tab-panel">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">SEO/GEO Check Rules</h2>
                    <button onclick="addSeoRule()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Rule
                    </button>
                </div>
                <div id="seoRulesList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading rules...</p>
                </div>
            </div>
        </div>

        <!-- Voice & Tone Tab -->
        <div id="panel-voice" class="tab-panel hidden">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Voice &amp; Tone Guidelines</h2>
                    <button onclick="addVoiceRule()" class="btn-green text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Guideline
                    </button>
                </div>
                <div id="voiceRulesList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading guidelines...</p>
                </div>
            </div>
        </div>

        <!-- Brand Standards Tab -->
        <div id="panel-brand" class="tab-panel hidden">
            <div class="card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Brand Standards</h2>
                    <button onclick="addBrandStandard()" class="btn-orange text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                        <span>+</span> Add Standard
                    </button>
                </div>
                <div id="brandStandardsList" class="space-y-3">
                    <p class="text-secondary text-center py-8">Loading standards...</p>
                </div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="panel-logs" class="tab-panel hidden">
            <div class="card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">Audit Run History</h2>
                    <div class="flex items-center gap-3">
                        <!-- Date Range Filter -->
                        <div class="flex items-center gap-2">
                            <select id="dateRangeFilter" onchange="handleDateRangeChange()" class="input-dark border rounded-lg px-3 py-2 text-sm">
                                <option value="30">Last 30 days</option>
                                <option value="60">Last 60 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="180">Last 6 months</option>
                                <option value="365">Last 12 months</option>
                                <option value="ytd">Year to date</option>
                                <option value="custom">Custom range</option>
                            </select>
                        </div>
                        <!-- Custom Date Range (hidden by default) -->
                        <div id="customDateRange" class="hidden flex items-center gap-2">
                            <div class="relative">
                                <input type="date" id="dateFrom" class="input-dark border rounded-lg px-3 py-2 text-sm pr-8 cursor-pointer" onchange="loadAuditLogs()">
                                <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-secondary pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <span class="text-secondary">to</span>
                            <div class="relative">
                                <input type="date" id="dateTo" class="input-dark border rounded-lg px-3 py-2 text-sm pr-8 cursor-pointer" onchange="loadAuditLogs()">
                                <svg class="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-secondary pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                        </div>
                        <button onclick="loadAuditLogs()" class="btn-cyan px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                        <button onclick="clearAuditLogs()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Clear Logs
                        </button>
                    </div>
                </div>
                <div id="auditLogsList" class="space-y-4">
                    <p class="text-secondary text-center py-8">Loading audit logs...</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="panel-settings" class="tab-panel hidden">
            <!-- Site Information Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Site Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <p class="text-secondary text-sm mb-1">Site ID</p>
                        <p id="displaySiteId" class="text-primary font-mono text-lg">-</p>
                    </div>
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <p class="text-secondary text-sm mb-1">Site Name</p>
                        <p id="displaySiteName" class="text-primary text-lg">-</p>
                    </div>
                </div>
            </div>

            <!-- Connection Status Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Connection Status
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-primary font-medium">Firestore Database</p>
                                    <p class="text-secondary text-sm">Cloud database for rules & logs</p>
                                </div>
                            </div>
                            <div id="firestoreStatus" class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                                <span class="text-secondary text-sm">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark rounded-lg p-4 border border-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-primary font-medium">Monday.com</p>
                                    <p class="text-secondary text-sm">Task management integration</p>
                                </div>
                            </div>
                            <div id="mondayStatus" class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <span class="text-secondary text-sm">Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Configuration Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                    </svg>
                    Audit Configuration
                </h2>
                <div class="space-y-4">
                    <!-- Sitemap URL -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Sitemap URL</label>
                        <div class="flex gap-2">
                            <input type="url" id="configSitemapUrl" class="flex-1 input-dark border rounded-lg px-4 py-2"
                                   value="https://www.outrigger.com/sitemap.xml" placeholder="https://example.com/sitemap.xml">
                            <button onclick="testSitemapUrl()" class="btn-cyan px-4 py-2 rounded-lg text-sm font-medium">Test</button>
                        </div>
                        <p class="text-xs text-secondary mt-1">The sitemap used to discover pages for auditing</p>
                    </div>

                    <!-- Days to Check -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Pages Modified Within (days)</label>
                        <input type="number" id="configDaysToCheck" class="w-32 input-dark border rounded-lg px-4 py-2"
                               value="7" min="1" max="365">
                        <p class="text-xs text-secondary mt-1">Only audit pages modified within this timeframe</p>
                    </div>

                    <!-- Max Pages Per Audit -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Max Pages Per Audit</label>
                        <select id="configMaxPages" class="input-dark border rounded-lg px-4 py-2">
                            <option value="1">1 (Testing)</option>
                            <option value="5">5 pages</option>
                            <option value="10">10 pages</option>
                            <option value="25">25 pages</option>
                            <option value="50">50 pages</option>
                            <option value="100">100 pages</option>
                            <option value="0">Unlimited</option>
                        </select>
                        <p class="text-xs text-secondary mt-1">Limit pages per audit run to control API costs</p>
                    </div>
                </div>
            </div>

            <!-- Scheduler Settings Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Audit Schedule
                </h2>
                <div class="space-y-4">
                    <!-- Schedule Enable Toggle -->
                    <div class="flex items-center gap-3 p-3 bg-dark rounded-lg">
                        <input type="checkbox" id="scheduleEnabled" class="w-5 h-5 rounded bg-dark border-card accent-cyan-500" onchange="toggleScheduleOptions()">
                        <div class="flex-1">
                            <label for="scheduleEnabled" class="text-primary font-medium cursor-pointer">Enable Scheduled Audits</label>
                            <p class="text-xs text-secondary">Automatically run audits on a recurring schedule</p>
                        </div>
                        <span id="scheduleStatusBadge" class="px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-400">Disabled</span>
                    </div>

                    <!-- Schedule Options (hidden until enabled) -->
                    <div id="scheduleOptions" class="hidden space-y-4 pt-2">
                        <!-- Frequency Selection -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">Frequency</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center justify-center gap-2 p-3 rounded-lg bg-dark border border-card hover:border-cyan-500/50 cursor-pointer transition has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/10">
                                    <input type="radio" name="scheduleFrequency" value="daily" class="sr-only" onchange="updateScheduleUI()">
                                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-primary text-sm">Daily</span>
                                </label>
                                <label class="flex items-center justify-center gap-2 p-3 rounded-lg bg-dark border border-card hover:border-cyan-500/50 cursor-pointer transition has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/10">
                                    <input type="radio" name="scheduleFrequency" value="weekly" class="sr-only" checked onchange="updateScheduleUI()">
                                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <span class="text-primary text-sm">Weekly</span>
                                </label>
                                <label class="flex items-center justify-center gap-2 p-3 rounded-lg bg-dark border border-card hover:border-cyan-500/50 cursor-pointer transition has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/10">
                                    <input type="radio" name="scheduleFrequency" value="monthly" class="sr-only" onchange="updateScheduleUI()">
                                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    <span class="text-primary text-sm">Monthly</span>
                                </label>
                            </div>
                        </div>

                        <!-- Day of Week (for weekly) -->
                        <div id="weeklyDaySelect">
                            <label class="block text-sm font-medium text-secondary mb-2">Day of Week</label>
                            <select id="scheduleDayOfWeek" class="input-dark border rounded-lg px-4 py-2 w-full" onchange="updateScheduleSummary()">
                                <option value="0">Sunday</option>
                                <option value="1" selected>Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>

                        <!-- Day of Month (for monthly) -->
                        <div id="monthlyDaySelect" class="hidden">
                            <label class="block text-sm font-medium text-secondary mb-2">Day of Month</label>
                            <select id="scheduleDayOfMonth" class="input-dark border rounded-lg px-4 py-2 w-full" onchange="updateScheduleSummary()">
                                <option value="1">1st</option>
                                <option value="7">7th</option>
                                <option value="14">14th</option>
                                <option value="15" selected>15th</option>
                                <option value="21">21st</option>
                                <option value="28">28th</option>
                                <option value="last">Last day</option>
                            </select>
                        </div>

                        <!-- Time of Day -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">Time (24-hour)</label>
                            <div class="flex gap-2 items-center">
                                <select id="scheduleHour" class="input-dark border rounded-lg px-4 py-2" onchange="updateScheduleSummary()">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6" selected>06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                                <span class="text-secondary text-sm">UTC</span>
                            </div>
                            <p class="text-xs text-secondary mt-1">Audit will run at this time in UTC timezone</p>
                        </div>

                        <!-- Date Range -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">Date Range</label>
                            <div class="flex items-center gap-3 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="scheduleDateRange" value="always" class="w-4 h-4 accent-cyan-500" checked onchange="toggleDateRangeInputs()">
                                    <span class="text-primary text-sm">Run indefinitely</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="scheduleDateRange" value="range" class="w-4 h-4 accent-cyan-500" onchange="toggleDateRangeInputs()">
                                    <span class="text-primary text-sm">Set date range</span>
                                </label>
                            </div>
                            <div id="dateRangeInputs" class="hidden grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-secondary mb-1">Start Date</label>
                                    <input type="date" id="scheduleStartDate" class="input-dark border rounded-lg px-4 py-2 w-full" onchange="updateScheduleSummary()">
                                </div>
                                <div>
                                    <label class="block text-xs text-secondary mb-1">End Date</label>
                                    <input type="date" id="scheduleEndDate" class="input-dark border rounded-lg px-4 py-2 w-full" onchange="updateScheduleSummary()">
                                </div>
                            </div>
                        </div>

                        <!-- Audit Types for Schedule -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">Audit Types</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-dark border border-card hover:border-purple-500/50 cursor-pointer transition">
                                    <input type="checkbox" id="scheduleSeo" class="w-4 h-4 accent-purple-500" checked>
                                    <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                                    <span class="text-primary text-sm">SEO/GEO</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-dark border border-card hover:border-green-500/50 cursor-pointer transition">
                                    <input type="checkbox" id="scheduleVoice" class="w-4 h-4 accent-green-500" checked>
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    <span class="text-primary text-sm">Voice</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-dark border border-card hover:border-orange-500/50 cursor-pointer transition">
                                    <input type="checkbox" id="scheduleBrand" class="w-4 h-4 accent-orange-500" checked>
                                    <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                                    <span class="text-primary text-sm">Brand</span>
                                </label>
                            </div>
                        </div>

                        <!-- Schedule Summary -->
                        <div class="p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <p class="text-cyan-300 text-sm font-medium">Schedule Summary</p>
                                    <p id="scheduleSummary" class="text-cyan-200/80 text-sm mt-1">Audits will run every Monday at 06:00 UTC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LLM Settings Card -->
            <div class="card rounded-xl p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI / LLM Settings
                </h2>
                <div class="space-y-4">
                    <!-- AI Model -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">AI Model</label>
                        <select id="configAiModel" class="input-dark border rounded-lg px-4 py-2">
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Faster/Cheaper)</option>
                        </select>
                        <p class="text-xs text-secondary mt-1">Model used for voice/tone and brand compliance checks</p>
                    </div>

                    <!-- Max Rules Per Batch -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Rules Per LLM Batch</label>
                        <input type="number" id="configRulesPerBatch" class="w-32 input-dark border rounded-lg px-4 py-2"
                               value="5" min="1" max="20">
                        <p class="text-xs text-secondary mt-1">Number of rules to evaluate per API call (lower = more accurate, higher = faster)</p>
                    </div>

                    <!-- Enable/Disable LLM Auditing -->
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="configEnableLLM" class="w-5 h-5 rounded bg-dark border-card accent-purple-500" checked>
                        <div>
                            <label for="configEnableLLM" class="text-primary font-medium cursor-pointer">Enable AI-Powered Auditing</label>
                            <p class="text-xs text-secondary">Voice/tone and brand compliance checks use Claude AI</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card rounded-xl p-6 border-red-500/30">
                <h2 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Danger Zone
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-dark rounded-lg border border-red-500/20">
                        <div>
                            <p class="text-primary font-medium">Clear All Audit Logs</p>
                            <p class="text-secondary text-sm">Permanently delete all audit history from Firestore</p>
                        </div>
                        <button onclick="confirmClearLogs()" class="px-4 py-2 rounded-lg border border-red-500 text-red-400 hover:bg-red-500/10 transition text-sm font-medium">
                            Clear Logs
                        </button>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-dark rounded-lg border border-red-500/20">
                        <div>
                            <p class="text-primary font-medium">Reset All Rules to Defaults</p>
                            <p class="text-secondary text-sm">Replace all SEO, voice, and brand rules with defaults</p>
                        </div>
                        <button onclick="confirmResetRules()" class="px-4 py-2 rounded-lg border border-red-500 text-red-400 hover:bg-red-500/10 transition text-sm font-medium">
                            Reset Rules
                        </button>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-dark rounded-lg border border-red-500/40">
                        <div>
                            <p class="text-red-400 font-medium">Delete This Site</p>
                            <p class="text-secondary text-sm">Permanently remove this site and all its data (logs, rules, settings)</p>
                        </div>
                        <button onclick="confirmDeleteSite()" class="px-4 py-2 rounded-lg bg-red-500/20 border border-red-500 text-red-400 hover:bg-red-500/30 transition text-sm font-medium">
                            Delete Site
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Settings Button -->
            <div class="mt-6 flex justify-end">
                <button onclick="saveSettings()" class="btn-primary px-6 py-3 rounded-lg font-medium flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Settings
                </button>
            </div>
        </div>
    </main>
    </div><!-- End mainApp -->

    <!-- Modal for Adding/Editing -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-primary">Add Rule</h3>
                    <button onclick="closeModal()" class="text-secondary hover:text-primary transition" title="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="modalForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Name</label>
                        <input type="text" id="formName" class="w-full input-dark border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Description <span class="text-secondary/60 font-normal">(shown in dashboard)</span></label>
                        <textarea id="formDescription" rows="2" class="w-full input-dark border rounded-lg px-3 py-2" required></textarea>
                    </div>
                    <div id="extraFields"></div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="formEnabled" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                        <label for="formEnabled" class="text-sm text-secondary">Enabled</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg flex-1 font-medium">Save</button>
                        <button type="button" onclick="closeModal()" class="bg-card border border-card text-secondary hover:text-primary px-6 py-2 rounded-lg transition">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <!-- Reseed Rules Modal -->
    <div id="reseedModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-600 to-red-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white">Reset Rules to Defaults</h3>
                    <button onclick="closeReseedModal()" class="text-white/70 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="text-secondary mb-4">Select which rule types to reset. Your custom rules in selected categories will be replaced with defaults.</p>
                <div class="space-y-3 mb-6">
                    <label class="flex items-center gap-3 p-3 bg-dark rounded-lg border border-card cursor-pointer hover:border-purple-500/50 transition">
                        <input type="checkbox" id="reseedSeo" checked class="w-5 h-5 rounded bg-dark border-card accent-purple-500">
                        <div>
                            <span class="text-primary font-medium">SEO/GEO Rules</span>
                            <p class="text-secondary text-sm">Title, meta, H1, canonical, schema checks (legacy + LLM)</p>
                        </div>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-dark rounded-lg border border-card cursor-pointer hover:border-cyan-500/50 transition">
                        <input type="checkbox" id="reseedVoice" checked class="w-5 h-5 rounded bg-dark border-card accent-cyan-500">
                        <div>
                            <span class="text-primary font-medium">Voice & Tone</span>
                            <p class="text-secondary text-sm">Brand voice example rules (LLM-powered)</p>
                        </div>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-dark rounded-lg border border-card cursor-pointer hover:border-teal-500/50 transition">
                        <input type="checkbox" id="reseedBrand" checked class="w-5 h-5 rounded bg-dark border-card accent-teal-500">
                        <div>
                            <span class="text-primary font-medium">Brand Standards</span>
                            <p class="text-secondary text-sm">Brand consistency example rules (LLM-powered)</p>
                        </div>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button onclick="executeReseed()" class="flex-1 bg-gradient-to-r from-orange-600 to-red-500 text-white py-3 rounded-lg font-medium hover:opacity-90 transition">
                        Reset Selected
                    </button>
                    <button onclick="closeReseedModal()" class="flex-1 px-6 py-3 bg-card border border-card text-secondary hover:text-primary rounded-lg transition font-medium">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div id="confirmModalHeader" class="bg-gradient-to-r from-purple-600 to-cyan-500 px-6 py-4">
                <h3 id="confirmModalTitle" class="text-lg font-bold text-white">Confirm Action</h3>
            </div>
            <div class="p-6">
                <p id="confirmModalMessage" class="text-primary mb-6">Are you sure?</p>
                <div class="flex gap-3">
                    <button id="confirmModalYes" class="flex-1 btn-primary text-white py-3 rounded-lg font-medium">
                        Confirm
                    </button>
                    <button onclick="closeConfirmModal()" class="flex-1 px-6 py-3 bg-card border border-card text-secondary hover:text-primary rounded-lg transition font-medium">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GEO Score Detail Modal -->
    <div id="geoScoreModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 overflow-y-auto py-8">
        <div class="card rounded-2xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-cyan-600 to-teal-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-white">GEO/LLM Readiness Score</h3>
                        <p id="geoScoreModalDate" class="text-white/70 text-sm">Audit from...</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="flex items-baseline gap-1">
                                <span id="geoScoreModalAvg" class="text-4xl font-bold text-white">--</span>
                                <span class="text-white/70">/100</span>
                            </div>
                            <span id="geoScoreModalGrade" class="text-sm text-white/80">Grade: --</span>
                        </div>
                        <button onclick="closeGeoScoreModal()" class="text-white/70 hover:text-white transition" title="Close">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Score Range Summary -->
            <div class="px-6 py-4 border-b border-card bg-dark/50">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div id="geoScoreMin" class="text-2xl font-bold text-red-400">--</div>
                        <div class="text-xs text-secondary">Lowest</div>
                    </div>
                    <div>
                        <div id="geoScoreAvgCenter" class="text-2xl font-bold text-cyan-400">--</div>
                        <div class="text-xs text-secondary">Average</div>
                    </div>
                    <div>
                        <div id="geoScoreMax" class="text-2xl font-bold text-green-400">--</div>
                        <div class="text-xs text-secondary">Highest</div>
                    </div>
                </div>
            </div>

            <!-- Per-Page Scores -->
            <div class="px-6 py-4 max-h-[400px] overflow-y-auto">
                <h4 class="text-sm font-medium text-secondary mb-3">Page Scores</h4>
                <div id="geoScorePagesList" class="space-y-2">
                    <p class="text-secondary text-center py-4">No page scores available</p>
                </div>
            </div>

            <!-- Score Breakdown Legend -->
            <div class="px-6 py-4 border-t border-card bg-dark/30">
                <h4 class="text-sm font-medium text-secondary mb-3">Score Categories</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded bg-purple-500"></div>
                        <span class="text-secondary">Structured Data</span>
                        <span class="text-primary ml-auto">35 pts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded bg-blue-500"></div>
                        <span class="text-secondary">Content Signals</span>
                        <span class="text-primary ml-auto">25 pts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded bg-green-500"></div>
                        <span class="text-secondary">Technical</span>
                        <span class="text-primary ml-auto">25 pts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded bg-orange-500"></div>
                        <span class="text-secondary">Voice/AI Ready</span>
                        <span class="text-primary ml-auto">15 pts</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-card">
                <button onclick="closeGeoScoreModal()" class="w-full btn-primary text-white py-3 rounded-lg font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Progress Panel (shown during audit) -->
    <div id="auditProgressPanel" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-cyan-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white">Audit in Progress</h3>
                    <div class="flex items-center gap-3">
                        <span id="progressStatus" class="px-3 py-1 bg-white/20 rounded-full text-sm text-white">
                            Running...
                        </span>
                        <button onclick="closeProgressPanel()" class="text-white/70 hover:text-white transition" title="Close">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="px-6 py-4 border-b border-card">
                <div class="flex justify-between text-sm mb-2">
                    <span id="progressPhase" class="text-secondary">Initializing...</span>
                    <span id="progressPercent" class="text-primary font-medium">0%</span>
                </div>
                <div class="w-full bg-dark rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-cyan-400 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-4 gap-4 px-6 py-4 border-b border-card">
                <div class="text-center">
                    <div id="statPages" class="text-2xl font-bold text-primary">0/0</div>
                    <div class="text-xs text-secondary">Pages</div>
                </div>
                <div class="text-center">
                    <div id="statSeo" class="text-2xl font-bold text-yellow-400">0</div>
                    <div class="text-xs text-secondary">SEO Issues</div>
                </div>
                <div class="text-center">
                    <div id="statVoice" class="text-2xl font-bold text-purple-400">0</div>
                    <div class="text-xs text-secondary">Voice Issues</div>
                </div>
                <div class="text-center">
                    <div id="statBrand" class="text-2xl font-bold text-pink-400">0</div>
                    <div class="text-xs text-secondary">Brand Issues</div>
                </div>
            </div>

            <!-- Current Page -->
            <div class="px-6 py-3 border-b border-card">
                <div class="text-xs text-secondary mb-1">Currently auditing:</div>
                <div id="currentPageUrl" class="text-sm text-primary truncate">-</div>
            </div>

            <!-- Recent Issues -->
            <div class="px-6 py-4 max-h-48 overflow-y-auto">
                <div class="text-xs text-secondary mb-2">Recent Issues Found:</div>
                <div id="recentIssuesList" class="space-y-2">
                    <div class="text-sm text-secondary italic">Waiting for issues...</div>
                </div>
            </div>

            <!-- Footer (shown on complete) -->
            <div id="progressFooter" class="hidden px-6 py-4 bg-card border-t border-card">
                <button onclick="closeProgressPanel()" class="w-full btn-primary text-white py-3 rounded-lg font-medium">
                    View Full Results
                </button>
            </div>
        </div>
    </div>

    <!-- Run Audit Modal -->
    <div id="runAuditModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-xl font-bold text-primary mb-2">Run Audit</h3>

                <!-- Page Source Selection -->
                <div class="mb-4">
                    <p class="text-secondary text-sm mb-3">What would you like to audit?</p>
                    <div class="flex gap-2">
                        <button type="button" id="auditSourceSitemap" onclick="setAuditSource('sitemap')" class="flex-1 px-4 py-2 rounded-lg border-2 border-cyan-500 bg-cyan-500/10 text-cyan-400 font-medium text-sm transition">
                            Use Sitemap
                        </button>
                        <button type="button" id="auditSourceUrl" onclick="setAuditSource('url')" class="flex-1 px-4 py-2 rounded-lg border-2 border-card text-secondary font-medium text-sm hover:border-cyan-500/50 transition">
                            Single URL
                        </button>
                    </div>
                </div>

                <!-- Single URL Input (hidden by default) -->
                <div id="singleUrlInput" class="hidden mb-4">
                    <label class="block text-sm font-medium text-secondary mb-2">Page URL or Folder Path</label>
                    <input type="url" id="auditSingleUrl" class="w-full input-dark border rounded-lg px-4 py-3" placeholder="https://example.com/folder/page-to-audit">
                    <p class="text-xs text-secondary mt-1">Enter a single page URL or a folder path to scan</p>

                    <!-- Include Subfolders Checkbox -->
                    <label class="flex items-center gap-3 mt-3 p-3 rounded-lg bg-dark border border-card hover:border-cyan-500/50 cursor-pointer transition">
                        <input type="checkbox" id="includeSubfolders" class="w-5 h-5 rounded bg-dark border-card accent-cyan-500">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                </svg>
                                <span class="text-primary font-medium">Include Subfolders</span>
                            </div>
                            <p class="text-secondary text-xs mt-1">Scan all pages under this path from the sitemap</p>
                        </div>
                    </label>
                </div>

                <!-- Sitemap Info (shown by default) -->
                <div id="sitemapInfo" class="mb-4 p-3 bg-dark rounded-lg border border-card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-secondary">Will audit pages from configured sitemap</span>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="refreshSitemap" class="w-4 h-4 rounded bg-dark border-card accent-cyan-500">
                            <span class="text-xs text-secondary">Refresh sitemap</span>
                        </label>
                    </div>
                </div>


                <p class="text-secondary text-sm mb-3">Select audit types:</p>

                <div class="space-y-3 mb-6">
                    <!-- SEO/GEO Checkbox -->
                    <label class="flex items-center gap-3 p-3 rounded-lg bg-dark border border-card hover:border-purple-500/50 cursor-pointer transition">
                        <input type="checkbox" id="auditSeo" checked class="w-5 h-5 rounded bg-dark border-card accent-purple-500">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                                <span class="text-primary font-medium">SEO/GEO Rules</span>
                            </div>
                            <p class="text-secondary text-xs mt-1">Title tags, meta descriptions, schema markup, etc.</p>
                        </div>
                    </label>

                    <!-- Voice & Tone Checkbox -->
                    <label class="flex items-center gap-3 p-3 rounded-lg bg-dark border border-card hover:border-green-500/50 cursor-pointer transition">
                        <input type="checkbox" id="auditVoice" checked class="w-5 h-5 rounded bg-dark border-card accent-green-500">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span class="text-primary font-medium">Voice & Tone</span>
                            </div>
                            <p class="text-secondary text-xs mt-1">Warm hospitality tone, Hawaiian voice, sensory language</p>
                        </div>
                    </label>

                    <!-- Brand Standards Checkbox -->
                    <label class="flex items-center gap-3 p-3 rounded-lg bg-dark border border-card hover:border-orange-500/50 cursor-pointer transition">
                        <input type="checkbox" id="auditBrand" checked class="w-5 h-5 rounded bg-dark border-card accent-orange-500">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                                <span class="text-primary font-medium">Brand Standards</span>
                            </div>
                            <p class="text-secondary text-xs mt-1">Brand name usage, property names, image standards</p>
                        </div>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="startAuditWithOptions()" class="flex-1 btn-primary text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Start Audit
                    </button>
                    <button type="button" onclick="closeRunAuditModal()" class="px-6 py-3 bg-card border border-card text-secondary hover:text-primary rounded-lg transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Modal for Adding/Editing Sites -->
    <div id="siteModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="card rounded-xl shadow-2xl max-w-lg w-full mx-4">
            <div class="p-6">
                <h3 id="siteModalTitle" class="text-xl font-bold text-primary mb-4">Add Site</h3>
                <form id="siteModalForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Site Name</label>
                        <input type="text" id="siteName" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., Outrigger Hotels" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Site ID (URL-safe, no spaces)</label>
                        <input type="text" id="siteId" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., outrigger" pattern="[a-z0-9-]+" required>
                        <p class="text-xs text-secondary mt-1">Lowercase letters, numbers, and hyphens only</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Domain</label>
                        <input type="text" id="siteDomain" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., outrigger.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Sitemap URL</label>
                        <input type="url" id="siteSitemapUrl" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="https://www.example.com/sitemap.xml" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Monday.com Board ID</label>
                        <input type="text" id="siteMondayBoardId" class="w-full input-dark border rounded-lg px-3 py-2" placeholder="e.g., 18395774522">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Days to Check</label>
                            <input type="number" id="siteDaysToCheck" class="w-full input-dark border rounded-lg px-3 py-2" value="7" min="1" max="90">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Max Pages</label>
                            <input type="number" id="siteMaxPages" class="w-full input-dark border rounded-lg px-3 py-2" value="10" min="1" max="100">
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="siteEnableLLM" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                            <label for="siteEnableLLM" class="text-sm text-secondary">Enable LLM Audits</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="siteEnabled" class="w-4 h-4 rounded bg-dark border-card accent-purple-500" checked>
                            <label for="siteEnabled" class="text-sm text-secondary">Site Enabled</label>
                        </div>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg flex-1 font-medium">Save Site</button>
                        <button type="button" onclick="closeSiteModal()" class="bg-card border border-card text-secondary hover:text-primary px-6 py-2 rounded-lg transition">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============ AUTHENTICATION ============
        const AUTH_COOKIE_NAME = 'outrigger_auth';
        const AUTH_COOKIE_DAYS = 30;
        const VALID_PASSWORD = 'outrigger2026';
        const VALID_DOMAIN = '@outrigger.com';

        // Cookie helpers
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/;SameSite=Strict';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/';
        }

        // Check authentication on page load
        function checkAuth() {
            const authData = getCookie(AUTH_COOKIE_NAME);
            if (authData) {
                try {
                    const { email, expires } = JSON.parse(authData);
                    if (email && email.toLowerCase().endsWith(VALID_DOMAIN) && new Date(expires) > new Date()) {
                        showApp(email);
                        return true;
                    }
                } catch (e) {
                    console.error('Invalid auth cookie');
                }
            }
            showLogin();
            return false;
        }

        // Show login screen
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Show main app
        function showApp(email) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = email;
            // Load sites first, then data will load when site is selected
            loadSites();
            // Small delay to ensure site selector has loaded
            setTimeout(function() {
                loadAllData();
                loadLastRunTime();
                // Show the initial tab from URL parameter
                showTab(initialTab);
                // Check if there's a running audit and show progress panel
                checkForRunningAudit();
            }, 500);
        }

        // Cloud Run API URL
        const API_URL = 'https://outrigger-seo-audit-22338575803.us-central1.run.app';

        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toastContainer');

            var toast = document.createElement('div');
            toast.className = 'toast-notification transform translate-x-full opacity-0 transition-all duration-300';

            var bgColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500/90';
                    icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
                    break;
                case 'error':
                    bgColor = 'bg-red-500/90';
                    icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500/90';
                    icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>';
                    break;
                default:
                    bgColor = 'bg-cyan-500/90';
                    icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
            }

            toast.innerHTML = '<div class="' + bgColor + ' backdrop-blur-sm text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]">' +
                '<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">' + icon + '</svg>' +
                '<span class="flex-1">' + message + '</span>' +
                '<button onclick="this.parentElement.parentElement.remove()" class="text-white/70 hover:text-white">' +
                    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' +
                '</button>' +
            '</div>';

            container.appendChild(toast);

            // Animate in
            setTimeout(function() {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);

            // Auto remove after 4 seconds
            setTimeout(function() {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(function() {
                    if (toast.parentElement) toast.remove();
                }, 300);
            }, 4000);
        }

        // ============ CONFIRM MODAL ============
        var confirmCallback = null;

        function showConfirm(title, message, onConfirm, type) {
            type = type || 'default';
            confirmCallback = onConfirm;

            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;

            var header = document.getElementById('confirmModalHeader');
            var yesBtn = document.getElementById('confirmModalYes');

            if (type === 'danger') {
                header.className = 'bg-gradient-to-r from-red-600 to-red-500 px-6 py-4';
                yesBtn.className = 'flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-medium transition';
                yesBtn.textContent = 'Delete';
            } else {
                header.className = 'bg-gradient-to-r from-purple-600 to-cyan-500 px-6 py-4';
                yesBtn.className = 'flex-1 btn-primary text-white py-3 rounded-lg font-medium';
                yesBtn.textContent = 'Confirm';
            }

            // Clone and replace button to remove any old event listeners
            var newBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newBtn, yesBtn);

            newBtn.addEventListener('click', function() {
                var callback = confirmCallback;
                closeConfirmModal();
                if (callback) callback();
            });

            var modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeConfirmModal() {
            var modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            confirmCallback = null;
        }

        // Load last run time from Firestore (site-specific)
        function loadLastRunTime() {
            getSiteCollection('auditLogs').orderBy('timestamp', 'desc').limit(1).get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        document.getElementById('lastRunTime').textContent = 'Never';
                    } else {
                        var lastLog = snapshot.docs[0].data();
                        if (lastLog.timestamp) {
                            var date = lastLog.timestamp.toDate();
                            var timeAgo = getTimeAgo(date);
                            document.getElementById('lastRunTime').textContent = timeAgo;
                            document.getElementById('lastRunTime').title = date.toLocaleString();
                        } else {
                            document.getElementById('lastRunTime').textContent = 'Unknown';
                        }
                    }
                })
                .catch(function(error) {
                    console.error('Error loading last run time:', error);
                    document.getElementById('lastRunTime').textContent = 'Error';
                });
        }

        // Get human-readable time ago string
        function getTimeAgo(date) {
            var seconds = Math.floor((new Date() - date) / 1000);
            var interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + ' year' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + ' month' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + ' day' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + ' hour' + (interval > 1 ? 's' : '') + ' ago';
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + ' minute' + (interval > 1 ? 's' : '') + ' ago';
            return 'Just now';
        }

        // ============ AUDIT PROGRESS PANEL ============
        var progressUnsubscribe = null;

        function showProgressPanel() {
            var panel = document.getElementById('auditProgressPanel');
            panel.classList.remove('hidden');
            panel.classList.add('flex');
            document.getElementById('progressFooter').classList.add('hidden');

            // Reset UI to initial state
            document.getElementById('progressStatus').textContent = 'Running...';
            document.getElementById('progressStatus').className = 'px-3 py-1 bg-white/20 rounded-full text-sm text-white';
            document.getElementById('progressPhase').textContent = 'Initializing...';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('statPages').textContent = '0/0';
            document.getElementById('statSeo').textContent = '0';
            document.getElementById('statVoice').textContent = '0';
            document.getElementById('statBrand').textContent = '0';
            document.getElementById('currentPageUrl').textContent = '-';
            document.getElementById('recentIssuesList').innerHTML = '<div class="text-sm text-secondary italic">Waiting for issues...</div>';
        }

        function closeProgressPanel() {
            var panel = document.getElementById('auditProgressPanel');
            panel.classList.add('hidden');
            panel.classList.remove('flex');

            // Unsubscribe from progress updates
            if (progressUnsubscribe) {
                progressUnsubscribe();
                progressUnsubscribe = null;
            }

            // Reload audit logs to show new results
            loadAuditLogs();
            loadLastRunTime();

            // Switch to logs tab
            showTab('logs');
        }

        // Check for running audit on page load and show progress panel if one is active
        function checkForRunningAudit() {
            if (!currentSiteId) return;

            var progressRef = db.collection('sites').doc(currentSiteId).collection('auditProgress').doc('current');
            progressRef.get().then(function(doc) {
                if (doc.exists) {
                    var data = doc.data();
                    // If status is 'running', show the progress panel
                    if (data.status === 'running') {
                        console.log('Found running audit, showing progress panel');
                        showProgressPanel();
                        subscribeToProgress(currentSiteId);
                        // Update UI with current data immediately
                        updateProgressUI(data);
                    }
                }
            }).catch(function(error) {
                console.error('Error checking for running audit:', error);
            });
        }

        function subscribeToProgress(siteId) {
            var progressRef = db.collection('sites').doc(siteId).collection('auditProgress').doc('current');

            progressUnsubscribe = progressRef.onSnapshot(function(doc) {
                if (!doc.exists) return;
                var data = doc.data();
                updateProgressUI(data);
            }, function(error) {
                console.error('Progress subscription error:', error);
            });
        }

        function updateProgressUI(data) {
            // Update status badge
            var statusEl = document.getElementById('progressStatus');
            if (data.status === 'completed') {
                statusEl.textContent = 'Complete!';
                statusEl.className = 'px-3 py-1 bg-green-500/30 rounded-full text-sm text-green-300';
                document.getElementById('progressFooter').classList.remove('hidden');
            } else if (data.status === 'error') {
                statusEl.textContent = 'Error';
                statusEl.className = 'px-3 py-1 bg-red-500/30 rounded-full text-sm text-red-300';
                document.getElementById('progressFooter').classList.remove('hidden');
            } else {
                statusEl.textContent = 'Running...';
                statusEl.className = 'px-3 py-1 bg-white/20 rounded-full text-sm text-white';
            }

            // Update phase text
            document.getElementById('progressPhase').textContent = data.phaseLabel || 'Processing...';

            // Update progress bar
            var percent = data.totalPages > 0 ? Math.round((data.currentPage / data.totalPages) * 100) : 0;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';

            // Update stats
            document.getElementById('statPages').textContent = (data.currentPage || 0) + '/' + (data.totalPages || 0);
            document.getElementById('statSeo').textContent = data.seoIssues || 0;
            document.getElementById('statVoice').textContent = data.voiceIssues || 0;
            document.getElementById('statBrand').textContent = data.brandIssues || 0;

            // Update current page URL
            document.getElementById('currentPageUrl').textContent = data.currentPageUrl || '-';

            // Update recent issues
            if (data.recentIssues && data.recentIssues.length > 0) {
                var listEl = document.getElementById('recentIssuesList');
                listEl.innerHTML = data.recentIssues.slice(-5).reverse().map(function(issue) {
                    var typeColor = issue.type === 'seo' ? 'text-yellow-400' :
                                  issue.type === 'voice' ? 'text-purple-400' : 'text-pink-400';
                    return '<div class="flex items-center gap-2 text-sm">' +
                        '<span class="' + typeColor + ' uppercase text-xs font-medium">' + issue.type + '</span>' +
                        '<span class="text-primary truncate flex-1">' + issue.rule + '</span>' +
                    '</div>';
                }).join('');
            }
        }

        // ============ RUN AUDIT MODAL ============
        var currentAuditSource = 'sitemap'; // 'sitemap' or 'url'

        function openRunAuditModal() {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }
            // Reset to sitemap mode
            setAuditSource('sitemap');
            document.getElementById('auditSingleUrl').value = '';

            var modal = document.getElementById('runAuditModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeRunAuditModal() {
            var modal = document.getElementById('runAuditModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function setAuditSource(source) {
            currentAuditSource = source;
            var sitemapBtn = document.getElementById('auditSourceSitemap');
            var urlBtn = document.getElementById('auditSourceUrl');
            var sitemapInfo = document.getElementById('sitemapInfo');
            var urlInput = document.getElementById('singleUrlInput');

            if (source === 'sitemap') {
                sitemapBtn.className = 'flex-1 px-4 py-2 rounded-lg border-2 border-cyan-500 bg-cyan-500/10 text-cyan-400 font-medium text-sm transition';
                urlBtn.className = 'flex-1 px-4 py-2 rounded-lg border-2 border-card text-secondary font-medium text-sm hover:border-cyan-500/50 transition';
                sitemapInfo.classList.remove('hidden');
                urlInput.classList.add('hidden');
            } else {
                urlBtn.className = 'flex-1 px-4 py-2 rounded-lg border-2 border-cyan-500 bg-cyan-500/10 text-cyan-400 font-medium text-sm transition';
                sitemapBtn.className = 'flex-1 px-4 py-2 rounded-lg border-2 border-card text-secondary font-medium text-sm hover:border-cyan-500/50 transition';
                sitemapInfo.classList.add('hidden');
                urlInput.classList.remove('hidden');
                // Focus the input
                setTimeout(function() {
                    document.getElementById('auditSingleUrl').focus();
                }, 100);
            }
        }

        function startAuditWithOptions() {
            // Get selected audit types
            var auditTypes = {
                seo: document.getElementById('auditSeo').checked,
                voice: document.getElementById('auditVoice').checked,
                brand: document.getElementById('auditBrand').checked
            };

            // Ensure at least one is selected
            if (!auditTypes.seo && !auditTypes.voice && !auditTypes.brand) {
                showToast('Please select at least one audit type', 'warning');
                return;
            }

            // Get single URL if in URL mode
            var singleUrl = null;
            var includeSubfolders = false;
            if (currentAuditSource === 'url') {
                singleUrl = document.getElementById('auditSingleUrl').value.trim();
                includeSubfolders = document.getElementById('includeSubfolders').checked;
                if (!singleUrl) {
                    showToast('Please enter a URL to audit', 'warning');
                    return;
                }
                // Basic URL validation
                if (!singleUrl.startsWith('http://') && !singleUrl.startsWith('https://')) {
                    showToast('Please enter a valid URL starting with http:// or https://', 'warning');
                    return;
                }
            }

            // Close the modal
            closeRunAuditModal();

            // Run the audit with options
            runAuditNow(auditTypes, singleUrl, includeSubfolders);
        }

        // Run audit now
        function runAuditNow(auditTypes, singleUrl, includeSubfolders) {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }

            // Default to all if not specified
            auditTypes = auditTypes || { seo: true, voice: true, brand: true };
            includeSubfolders = includeSubfolders || false;

            var btn = document.getElementById('runAuditBtn');
            var originalContent = btn.innerHTML;

            // Update button to show loading state
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Running...';
            btn.classList.add('opacity-75');

            // Show progress panel and subscribe to updates
            showProgressPanel();
            subscribeToProgress(currentSiteId);

            // Build request body
            var requestBody = {
                site_id: currentSiteId,
                audit_types: auditTypes
            };

            // Add single URL if provided
            if (singleUrl) {
                requestBody.single_url = singleUrl;
                requestBody.include_subfolders = includeSubfolders;
            } else {
                // For sitemap mode, check if refresh is requested
                var refreshSitemap = document.getElementById('refreshSitemap');
                if (refreshSitemap && refreshSitemap.checked) {
                    requestBody.refresh_sitemap = true;
                }
            }

            // Make POST request to trigger audit for current site with audit type options
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('Audit response:', data);
                // Progress panel will update via Firestore subscription
                // The panel will show completion status and "View Results" button
            })
            .catch(function(error) {
                console.error('Error running audit:', error);
                // Update progress panel to show error
                updateProgressUI({
                    status: 'error',
                    phaseLabel: 'Error: ' + error.message,
                    error: error.message
                });
            })
            .finally(function() {
                // Restore button
                btn.disabled = false;
                btn.innerHTML = originalContent;
                btn.classList.remove('opacity-75');
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            // Validate email domain
            if (!email.endsWith(VALID_DOMAIN)) {
                errorEl.textContent = 'Access restricted to @outrigger.com email addresses';
                errorEl.classList.remove('hidden');
                return;
            }

            // Validate password
            if (password !== VALID_PASSWORD) {
                errorEl.textContent = 'Invalid password';
                errorEl.classList.remove('hidden');
                return;
            }

            // Success - set cookie for 30 days
            const expires = new Date();
            expires.setTime(expires.getTime() + (AUTH_COOKIE_DAYS * 24 * 60 * 60 * 1000));
            const authData = JSON.stringify({ email: email, expires: expires.toISOString() });
            setCookie(AUTH_COOKIE_NAME, authData, AUTH_COOKIE_DAYS);

            errorEl.classList.add('hidden');
            showApp(email);
        }

        // Logout
        function logout() {
            deleteCookie(AUTH_COOKIE_NAME);
            showLogin();
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Attach login form handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            checkAuth();
        });

        // ============ FIREBASE & APP CODE ============

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDu4Ka6oFSUOH_7PAZW7k9-2u46SlmbBWE",
            authDomain: "project-85d26db5-f70f-487e-b0e.firebaseapp.com",
            projectId: "project-85d26db5-f70f-487e-b0e",
            storageBucket: "project-85d26db5-f70f-487e-b0e.firebasestorage.app",
            messagingSenderId: "22338575803",
            appId: "1:22338575803:web:58fef3f290892f25c5f89e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // State
        let currentTab = 'seo';
        let currentEditId = null;
        let currentCollection = null;
        let sites = [];
        let editingSiteId = null;

        // Get site and tab from URL parameters, fallback to localStorage
        var urlParams = new URLSearchParams(window.location.search);
        var currentSiteId = urlParams.get('site') || localStorage.getItem('selectedSite') || null;
        var initialTab = urlParams.get('tab') || 'seo';

        // ============ SITE MANAGEMENT ============

        // Load all sites for dropdown
        function loadSites() {
            var selector = document.getElementById('siteSelector');
            selector.innerHTML = '<option value="">Loading...</option>';

            db.collection('sites').get()
                .then(function(snapshot) {
                    sites = [];
                    var optionsHtml = '';

                    if (snapshot.empty) {
                        optionsHtml = '<option value="">No sites configured</option>';
                    } else {
                        snapshot.forEach(function(doc) {
                            var siteId = doc.id;
                            // Get the config subcollection for this site
                            db.collection('sites').doc(siteId).collection('config').doc('settings').get()
                                .then(function(configDoc) {
                                    if (configDoc.exists) {
                                        var config = configDoc.to_dict ? configDoc.to_dict() : configDoc.data();
                                        sites.push({ id: siteId, ...config });
                                        updateSiteSelector();
                                    }
                                });
                        });
                        // Initial update with site IDs while configs load
                        snapshot.forEach(function(doc) {
                            optionsHtml += '<option value="' + doc.id + '">' + doc.id + '</option>';
                        });
                    }

                    selector.innerHTML = optionsHtml;

                    // Select saved site or first available
                    if (currentSiteId && selector.querySelector('option[value="' + currentSiteId + '"]')) {
                        selector.value = currentSiteId;
                    } else if (snapshot.size > 0) {
                        // Saved site doesn't exist anymore, clear it and use first available
                        console.log('Saved site "' + currentSiteId + '" not found, switching to first available site');
                        localStorage.removeItem('selectedSite');
                        currentSiteId = snapshot.docs[0].id;
                        selector.value = currentSiteId;
                        localStorage.setItem('selectedSite', currentSiteId);
                        // Update URL to remove invalid site param
                        var urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('site', currentSiteId);
                        window.history.replaceState({}, '', window.location.pathname + '?' + urlParams.toString());
                    }
                })
                .catch(function(error) {
                    console.error('Error loading sites:', error);
                    selector.innerHTML = '<option value="">Error loading sites</option>';
                });
        }

        // Update site selector with full names
        function updateSiteSelector() {
            var selector = document.getElementById('siteSelector');
            var optionsHtml = '';
            sites.forEach(function(site) {
                var selected = site.id === currentSiteId ? ' selected' : '';
                var displayName = site.name || site.id;
                optionsHtml += '<option value="' + site.id + '"' + selected + '>' + displayName + '</option>';
            });
            if (optionsHtml) {
                selector.innerHTML = optionsHtml;
            }
        }

        // Switch to a different site
        function switchSite() {
            var selector = document.getElementById('siteSelector');
            var newSiteId = selector.value;

            // Get current tab from URL or default to 'seo'
            var urlParams = new URLSearchParams(window.location.search);
            var currentTab = urlParams.get('tab') || 'seo';

            // Reload page with new site and maintain current tab
            // Always include admin=true to stay in admin dashboard
            var newUrl = window.location.pathname + '?admin=true&site=' + encodeURIComponent(newSiteId) + '&tab=' + encodeURIComponent(currentTab);
            window.location.href = newUrl;
        }

        // Open modal to add a new site
        function openAddSiteModal() {
            editingSiteId = null;
            document.getElementById('siteModalTitle').textContent = 'Add New Site';
            document.getElementById('siteId').value = '';
            document.getElementById('siteId').disabled = false;
            document.getElementById('siteName').value = '';
            document.getElementById('siteDomain').value = '';
            document.getElementById('siteSitemapUrl').value = '';
            document.getElementById('siteMondayBoardId').value = '';
            document.getElementById('siteDaysToCheck').value = '7';
            document.getElementById('siteMaxPages').value = '10';
            document.getElementById('siteEnableLLM').checked = true;
            document.getElementById('siteEnabled').checked = true;
            document.getElementById('siteModal').classList.remove('hidden');
            document.getElementById('siteModal').classList.add('flex');
        }

        // Open modal to edit existing site
        function openEditSiteModal(siteId) {
            editingSiteId = siteId;
            document.getElementById('siteModalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = siteId;
            document.getElementById('siteId').disabled = true;

            // Load site config
            db.collection('sites').doc(siteId).collection('config').doc('settings').get()
                .then(function(doc) {
                    if (doc.exists) {
                        var config = doc.data();
                        document.getElementById('siteName').value = config.name || '';
                        document.getElementById('siteDomain').value = config.domain || '';
                        document.getElementById('siteSitemapUrl').value = config.sitemapUrl || '';
                        document.getElementById('siteMondayBoardId').value = config.mondayBoardId || '';
                        document.getElementById('siteDaysToCheck').value = config.daysToCheck || 7;
                        document.getElementById('siteMaxPages').value = config.maxPages || 10;
                        document.getElementById('siteEnableLLM').checked = config.enableLLM !== false;
                        document.getElementById('siteEnabled').checked = config.enabled !== false;
                    }
                    document.getElementById('siteModal').classList.remove('hidden');
                    document.getElementById('siteModal').classList.add('flex');
                });
        }

        // Close site modal
        function closeSiteModal() {
            document.getElementById('siteModal').classList.add('hidden');
            document.getElementById('siteModal').classList.remove('flex');
            editingSiteId = null;
        }

        // Save site configuration
        function saveSite(e) {
            e.preventDefault();
            var siteId = editingSiteId || document.getElementById('siteId').value.toLowerCase().replace(/[^a-z0-9-]/g, '-');
            var config = {
                name: document.getElementById('siteName').value,
                domain: document.getElementById('siteDomain').value,
                sitemapUrl: document.getElementById('siteSitemapUrl').value,
                mondayBoardId: document.getElementById('siteMondayBoardId').value,
                daysToCheck: parseInt(document.getElementById('siteDaysToCheck').value) || 7,
                maxPages: parseInt(document.getElementById('siteMaxPages').value) || 10,
                enableLLM: document.getElementById('siteEnableLLM').checked,
                enabled: document.getElementById('siteEnabled').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!editingSiteId) {
                config.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            // First, ensure the parent document exists (required for Firestore queries)
            db.collection('sites').doc(siteId).set({ id: siteId }, { merge: true })
                .then(function() {
                    // Then save the config in the subcollection
                    return db.collection('sites').doc(siteId).collection('config').doc('settings').set(config, { merge: true });
                })
                .then(function() {
                    closeSiteModal();
                    loadSites();
                    if (!editingSiteId) {
                        // Switch to the new site
                        currentSiteId = siteId;
                        localStorage.setItem('selectedSite', siteId);
                    }
                    loadAllData();
                    showToast('Site saved successfully!', 'success');
                })
                .catch(function(error) {
                    showToast('Error saving site: ' + error.message, 'error');
                });
        }

        // Get collection reference for current site
        function getSiteCollection(collectionName) {
            if (!currentSiteId) {
                console.warn('No site selected, using legacy collection');
                return db.collection(collectionName);
            }
            return db.collection('sites').doc(currentSiteId).collection(collectionName);
        }

        // Update connection status (header indicator)
        function updateConnectionStatus(connected) {
            var statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400" title="Connected to Firestore"></span>';
            } else {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400" title="Firestore Connection Error"></span>';
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            currentTab = tabName;
            // Visible tabs (settings has no tab button, accessed via gear)
            var visibleTabs = ['seo', 'voice', 'brand', 'logs'];
            var allPanels = ['seo', 'voice', 'brand', 'logs', 'settings'];

            // Update URL with current tab (without reloading)
            var urlParams = new URLSearchParams(window.location.search);
            urlParams.set('tab', tabName);
            if (currentSiteId) {
                urlParams.set('site', currentSiteId);
            }
            var newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState({}, '', newUrl);

            // Update tab button styles
            visibleTabs.forEach(function(tab) {
                var tabBtn = document.getElementById('tab-' + tab);
                if (tab === tabName) {
                    tabBtn.className = 'px-5 py-2 font-medium transition-all tab-active rounded-lg text-sm';
                } else {
                    tabBtn.className = 'px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm';
                }
            });

            // If settings is selected, deactivate all visible tabs
            if (tabName === 'settings') {
                visibleTabs.forEach(function(tab) {
                    document.getElementById('tab-' + tab).className = 'px-5 py-2 font-medium transition-all tab-inactive rounded-lg text-sm';
                });
            }

            // Show/hide panels
            allPanels.forEach(function(panel) {
                var panelEl = document.getElementById('panel-' + panel);
                if (panel === tabName) {
                    panelEl.classList.remove('hidden');
                } else {
                    panelEl.classList.add('hidden');
                }
            });

            // Load data when switching to specific tabs
            if (tabName === 'logs') {
                loadAuditLogs();
            }
            if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Load SEO Rules (site-specific)
        function loadSeoRules() {
            var container = document.getElementById('seoRulesList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading rules...</p>';

            getSiteCollection('seoRules').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No SEO rules configured for this site. Click "Add Rule" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var rule = doc.data();
                        html += createRuleCard(doc.id, rule, 'seo');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading SEO rules:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading rules. Check console for details.</p>';
                });
        }

        // Load Voice Rules (site-specific)
        function loadVoiceRules() {
            var container = document.getElementById('voiceRulesList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading guidelines...</p>';

            getSiteCollection('voiceRules').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No voice guidelines configured for this site. Click "Add Guideline" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var rule = doc.data();
                        html += createRuleCard(doc.id, rule, 'voice');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading voice rules:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading guidelines. Check console for details.</p>';
                });
        }

        // Load Brand Standards (site-specific)
        function loadBrandStandards() {
            var container = document.getElementById('brandStandardsList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Loading standards...</p>';

            getSiteCollection('brandStandards').orderBy('name').get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No brand standards configured for this site. Click "Add Standard" to create one.</p>';
                        return;
                    }
                    var html = '';
                    snapshot.forEach(function(doc) {
                        var standard = doc.data();
                        html += createRuleCard(doc.id, standard, 'brand');
                    });
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading brand standards:', error);
                    updateConnectionStatus(false);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading standards. Check console for details.</p>';
                });
        }

        // Handle date range filter change
        function handleDateRangeChange() {
            var filterValue = document.getElementById('dateRangeFilter').value;
            var customRangeEl = document.getElementById('customDateRange');

            if (filterValue === 'custom') {
                customRangeEl.classList.remove('hidden');
                // Set default custom dates (last 30 days)
                var today = new Date();
                var thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            } else {
                customRangeEl.classList.add('hidden');
            }
            loadAuditLogs();
        }

        // Get date range based on filter selection
        function getDateRange() {
            var filterValue = document.getElementById('dateRangeFilter').value;
            var endDate = new Date();
            var startDate = new Date();

            if (filterValue === 'custom') {
                var fromInput = document.getElementById('dateFrom').value;
                var toInput = document.getElementById('dateTo').value;
                if (fromInput && toInput) {
                    startDate = new Date(fromInput);
                    endDate = new Date(toInput);
                    endDate.setHours(23, 59, 59, 999); // End of day
                } else {
                    startDate.setDate(endDate.getDate() - 30);
                }
            } else if (filterValue === 'ytd') {
                startDate = new Date(endDate.getFullYear(), 0, 1); // January 1st
            } else {
                var days = parseInt(filterValue);
                startDate.setDate(endDate.getDate() - days);
            }

            return { startDate: startDate, endDate: endDate };
        }

        // Load Audit Logs (site-specific)
        function loadAuditLogs() {
            var container = document.getElementById('auditLogsList');
            container.innerHTML = '<p class="text-secondary text-center py-8">Loading audit logs...</p>';

            var dateRange = getDateRange();

            getSiteCollection('auditLogs')
                .where('timestamp', '>=', dateRange.startDate)
                .where('timestamp', '<=', dateRange.endDate)
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get()
                .then(function(snapshot) {
                    updateConnectionStatus(true);
                    // Filter out hidden logs
                    var visibleLogs = [];
                    snapshot.forEach(function(doc) {
                        var log = doc.data();
                        if (!log.hidden) {
                            visibleLogs.push({ id: doc.id, data: log });
                        }
                    });

                    if (visibleLogs.length === 0) {
                        container.innerHTML = '<p class="text-secondary text-center py-8">No audit logs found for this site in the selected date range.</p>';
                        return;
                    }
                    var html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                    visibleLogs.forEach(function(item) {
                        html += createLogCard(item.id, item.data);
                    });
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading audit logs:', error);
                    container.innerHTML = '<p class="text-red-400 text-center py-8">Error loading logs. Check console for details.</p>';
                });
        }

        // Clear Audit Logs (marks as hidden, doesn't delete)
        function clearAuditLogs() {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }

            showConfirm('Clear Audit Logs', 'This will hide all visible logs from the display (they can be restored later). Continue?', function() {
                performClearAuditLogs();
            });
        }

        function performClearAuditLogs() {
            var dateRange = getDateRange();
            var container = document.getElementById('auditLogsList');
            container.innerHTML = '<p class="text-secondary text-center py-8">Clearing logs...</p>';

            getSiteCollection('auditLogs')
                .where('timestamp', '>=', dateRange.startDate)
                .where('timestamp', '<=', dateRange.endDate)
                .get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        showToast('No logs to clear', 'info');
                        loadAuditLogs();
                        return;
                    }

                    // Use batch to update all docs
                    var batch = db.batch();
                    var count = 0;
                    snapshot.forEach(function(doc) {
                        var log = doc.data();
                        if (!log.hidden) {
                            batch.update(doc.ref, { hidden: true, hiddenAt: new Date() });
                            count++;
                        }
                    });

                    if (count === 0) {
                        showToast('No visible logs to clear', 'info');
                        loadAuditLogs();
                        return;
                    }

                    return batch.commit().then(function() {
                        showToast(count + ' log(s) have been cleared', 'success');
                        loadAuditLogs();
                    });
                })
                .catch(function(error) {
                    console.error('Error clearing logs:', error);
                    showToast('Error clearing logs: ' + error.message, 'error');
                    loadAuditLogs();
                });
        }

        // Store audit logs for CSV download
        var auditLogsCache = {};

        // Delete single audit log (soft delete - marks as hidden)
        function deleteAuditLog(logId) {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }
            if (!logId) {
                showToast('Invalid log ID', 'error');
                return;
            }

            showConfirm('Delete Log', 'Are you sure you want to delete this audit log?', function() {
                showToast('Deleting log...', 'info');

                var docRef = db.collection('sites').doc(currentSiteId).collection('auditLogs').doc(logId);

                docRef.update({ hidden: true, hiddenAt: new Date() })
                    .then(function() {
                        showToast('Audit log deleted', 'success');
                        delete auditLogsCache[logId];
                        loadAuditLogs();
                    })
                    .catch(function(error) {
                        console.error('Error deleting log:', error);
                        showToast('Error deleting log: ' + error.message, 'error');
                    });
            }, 'danger');
        }

        // ============ GEO SCORE MODAL ============
        function openGeoScoreModal(logId) {
            var log = auditLogsCache[logId];
            if (!log) {
                showToast('Log data not found', 'error');
                return;
            }

            var geoScore = log.geoScore || {};
            var pageScores = log.pageScores || [];
            var timestamp = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'Unknown';

            // Update header info
            document.getElementById('geoScoreModalDate').textContent = 'Audit from ' + timestamp;
            document.getElementById('geoScoreModalAvg').textContent = geoScore.average ? Math.round(geoScore.average) : '--';
            document.getElementById('geoScoreModalGrade').textContent = 'Grade: ' + (geoScore.grade || '--');

            // Update score range
            document.getElementById('geoScoreMin').textContent = geoScore.min || '--';
            document.getElementById('geoScoreAvgCenter').textContent = geoScore.average ? Math.round(geoScore.average) : '--';
            document.getElementById('geoScoreMax').textContent = geoScore.max || '--';

            // Color the average score
            var avgEl = document.getElementById('geoScoreModalAvg');
            var avg = geoScore.average || 0;
            if (avg >= 80) avgEl.className = 'text-4xl font-bold text-green-300';
            else if (avg >= 60) avgEl.className = 'text-4xl font-bold text-yellow-300';
            else avgEl.className = 'text-4xl font-bold text-red-300';

            // Build page scores list
            var listEl = document.getElementById('geoScorePagesList');
            if (pageScores.length === 0) {
                listEl.innerHTML = '<p class="text-secondary text-center py-4">No page scores available for this audit</p>';
            } else {
                // Sort by score descending
                var sorted = pageScores.slice().sort(function(a, b) { return b.score - a.score; });
                listEl.innerHTML = sorted.map(function(page) {
                    var scoreColor = page.score >= 80 ? 'text-green-400' : page.score >= 60 ? 'text-yellow-400' : 'text-red-400';
                    var barColor = page.score >= 80 ? 'bg-green-500' : page.score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                    var breakdown = page.breakdown || {};

                    // Build mini breakdown bars
                    var structuredScore = breakdown.structured_data ? breakdown.structured_data.score : 0;
                    var contentScore = breakdown.content_signals ? breakdown.content_signals.score : 0;
                    var technicalScore = breakdown.technical_foundation ? breakdown.technical_foundation.score : 0;
                    var voiceScore = breakdown.voice_readiness ? breakdown.voice_readiness.score : 0;

                    return '<div class="p-3 bg-dark rounded-lg border border-card hover:border-cyan-500/30 transition cursor-pointer" onclick="togglePageBreakdown(this)">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="text-sm text-primary truncate" title="' + page.url + '">' + page.url.replace(/^https?:\/\/[^\/]+/, '') + '</div>' +
                                '<div class="flex gap-1 mt-1">' +
                                    '<div class="h-1.5 rounded bg-purple-500" style="width: ' + (structuredScore / 35 * 40) + 'px" title="Structured: ' + structuredScore + '/35"></div>' +
                                    '<div class="h-1.5 rounded bg-blue-500" style="width: ' + (contentScore / 25 * 40) + 'px" title="Content: ' + contentScore + '/25"></div>' +
                                    '<div class="h-1.5 rounded bg-green-500" style="width: ' + (technicalScore / 25 * 40) + 'px" title="Technical: ' + technicalScore + '/25"></div>' +
                                    '<div class="h-1.5 rounded bg-orange-500" style="width: ' + (voiceScore / 15 * 40) + 'px" title="Voice: ' + voiceScore + '/15"></div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<span class="text-xl font-bold ' + scoreColor + '">' + page.score + '</span>' +
                                '<span class="text-xs text-secondary ml-1">' + page.grade + '</span>' +
                            '</div>' +
                            '<svg class="w-4 h-4 text-secondary transition-transform breakdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>' +
                            '</svg>' +
                        '</div>' +
                        '<div class="breakdown-details hidden mt-3 pt-3 border-t border-card text-xs space-y-2">' +
                            '<div class="flex justify-between"><span class="text-purple-400">Structured Data</span><span class="text-primary">' + structuredScore + '/35</span></div>' +
                            '<div class="flex justify-between"><span class="text-blue-400">Content Signals</span><span class="text-primary">' + contentScore + '/25</span></div>' +
                            '<div class="flex justify-between"><span class="text-green-400">Technical Foundation</span><span class="text-primary">' + technicalScore + '/25</span></div>' +
                            '<div class="flex justify-between"><span class="text-orange-400">Voice/AI Readiness</span><span class="text-primary">' + voiceScore + '/15</span></div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }

            // Show modal
            var modal = document.getElementById('geoScoreModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function togglePageBreakdown(el) {
            var details = el.querySelector('.breakdown-details');
            var arrow = el.querySelector('.breakdown-arrow');
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                details.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        function closeGeoScoreModal() {
            var modal = document.getElementById('geoScoreModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Create audit log card HTML (matching the design from screenshot)
        function createLogCard(id, log) {
            // Cache the log for CSV download
            auditLogsCache[id] = log;

            var timestamp = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'Unknown';
            var pagesAudited = log.pagesAudited || 0;
            var totalIssues = log.totalIssues || 0;
            var tasksCreated = log.tasksCreated || 0;
            var duplicatesSkipped = log.duplicatesSkipped || 0;

            // Calculate completion percentage (tasks created / total issues)
            var completionPct = totalIssues > 0 ? Math.round((tasksCreated / totalIssues) * 100) : 100;

            // Issue breakdown
            var seoIssues = log.seoIssues || 0;
            var voiceIssues = log.voiceIssues || 0;
            var brandIssues = log.brandIssues || 0;

            // Audit types that were run
            var auditTypes = log.auditTypes || { seo: true, voice: true, brand: true };
            var auditTypeBadges = '';
            if (auditTypes.seo) auditTypeBadges += '<span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">SEO</span>';
            if (auditTypes.voice) auditTypeBadges += '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs">Voice</span>';
            if (auditTypes.brand) auditTypeBadges += '<span class="px-2 py-0.5 bg-orange-500/20 text-orange-400 rounded text-xs">Brand</span>';

            return '<div class="card rounded-xl p-5 relative group">' +
                '<button onclick="deleteAuditLog(\'' + id + '\')" class="absolute top-3 right-3 text-secondary hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete this log">' +
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' +
                '</button>' +
                '<div class="flex justify-between items-start mb-4">' +
                    '<div>' +
                        '<h3 class="font-bold text-primary text-lg">Audit Run</h3>' +
                        '<p class="text-secondary text-sm">' + timestamp + '</p>' +
                        '<div class="flex gap-1 mt-1">' + auditTypeBadges + '</div>' +
                    '</div>' +
                    '<div class="text-right mr-6">' +
                        '<span class="text-2xl font-bold text-accent">' + completionPct + '%</span>' +
                        '<p class="text-secondary text-xs">Complete</p>' +
                    '</div>' +
                '</div>' +
                '<div class="space-y-2 mb-4">' +
                    '<div class="flex justify-between text-sm">' +
                        '<span class="text-secondary">Pages Audited</span>' +
                        '<span class="text-primary font-medium">' + pagesAudited + '</span>' +
                    '</div>' +
                    '<div class="flex justify-between text-sm">' +
                        '<span class="text-secondary">Issues Found</span>' +
                        '<span class="text-primary font-medium">' + totalIssues + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="text-xs text-secondary mb-3">Issue Breakdown</div>' +
                '<div class="grid grid-cols-2 gap-2 mb-4">' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-purple-500"></span>' +
                        '<span class="text-secondary text-sm">SEO/GEO</span>' +
                        '<span class="text-primary text-sm ml-auto">' + seoIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-green-500"></span>' +
                        '<span class="text-secondary text-sm">Voice/Tone</span>' +
                        '<span class="text-primary text-sm ml-auto">' + voiceIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-orange-500"></span>' +
                        '<span class="text-secondary text-sm">Brand</span>' +
                        '<span class="text-primary text-sm ml-auto">' + brandIssues + '</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="w-2 h-2 rounded-full bg-gray-500"></span>' +
                        '<span class="text-secondary text-sm">Duplicates</span>' +
                        '<span class="text-primary text-sm ml-auto">' + duplicatesSkipped + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="space-y-2 mb-4">' +
                    '<div>' +
                        '<div class="flex justify-between text-xs mb-1">' +
                            '<span class="text-green-400">Tasks Created</span>' +
                            '<span class="text-green-400">' + Math.round((tasksCreated / Math.max(totalIssues, 1)) * 100) + '%</span>' +
                        '</div>' +
                        '<div class="h-2 bg-dark rounded-full overflow-hidden">' +
                            '<div class="h-full bg-green-500 rounded-full" style="width: ' + Math.round((tasksCreated / Math.max(totalIssues, 1)) * 100) + '%"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                (log.issues && log.issues.length > 0 ?
                    '<div class="text-xs text-secondary mb-3 flex items-center gap-1">' +
                        '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>' +
                        '</svg>' +
                        log.issues.length + ' issue records stored' +
                    '</div>'
                : '<div class="text-xs text-secondary mb-3 opacity-50">No issue records (older audit)</div>') +
                '<button onclick="downloadLogCSV(\'' + id + '\')" class="w-full btn-cyan py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition">' +
                    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>' +
                    '</svg>' +
                    'Download CSV' +
                '</button>' +
            '</div>';
        }

        // Download audit log as CSV
        function downloadLogCSV(logId) {
            var log = auditLogsCache[logId];
            if (!log) {
                showToast('Log data not found', 'error');
                return;
            }

            var timestamp = log.timestamp ? new Date(log.timestamp.toDate()) : new Date();
            var dateStr = timestamp.toISOString().split('T')[0];

            // Create CSV content - Summary Section
            var csvContent = '=== AUDIT SUMMARY ===\n';
            csvContent += 'Metric,Value\n';
            csvContent += 'Audit Date,' + timestamp.toLocaleString() + '\n';
            csvContent += 'Pages Audited,' + (log.pagesAudited || 0) + '\n';
            csvContent += 'Total Issues,' + (log.totalIssues || 0) + '\n';
            csvContent += 'Tasks Created,' + (log.tasksCreated || 0) + '\n';
            csvContent += 'Duplicates Skipped,' + (log.duplicatesSkipped || 0) + '\n';
            csvContent += 'SEO/GEO Issues,' + (log.seoIssues || 0) + '\n';
            csvContent += 'Voice/Tone Issues,' + (log.voiceIssues || 0) + '\n';
            csvContent += 'Brand Issues,' + (log.brandIssues || 0) + '\n';

            // Add rules used if available
            if (log.rulesUsed) {
                csvContent += '\n=== RULES USED ===\n';
                csvContent += 'Rule Type,Count\n';
                csvContent += 'SEO Rules,' + (log.rulesUsed.seo || 0) + '\n';
                csvContent += 'Voice Rules,' + (log.rulesUsed.voice || 0) + '\n';
                csvContent += 'Brand Rules,' + (log.rulesUsed.brand || 0) + '\n';
            }

            // Add individual issues if available
            if (log.issues && log.issues.length > 0) {
                csvContent += '\n=== ALL ISSUES LOGGED TO MONDAY.COM ===\n';
                csvContent += 'URL,Issue Title,Category,Severity,Type,Monday Status,Rule Name,Description\n';

                log.issues.forEach(function(issue) {
                    // Escape fields that might contain commas or quotes
                    var escapeField = function(field) {
                        if (!field) return '';
                        var str = String(field);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    };

                    csvContent += escapeField(issue.url) + ',';
                    csvContent += escapeField(issue.title) + ',';
                    csvContent += escapeField(issue.category) + ',';
                    csvContent += escapeField(issue.severity) + ',';
                    csvContent += escapeField(issue.type) + ',';
                    csvContent += escapeField(issue.monday_status) + ',';
                    csvContent += escapeField(issue.rule_name) + ',';
                    csvContent += escapeField(issue.description) + '\n';
                });
            }

            // Create and trigger download
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'audit-log-' + dateStr + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Create rule card HTML
        function createRuleCard(id, data, type) {
            var statusClass = data.enabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400';
            var statusText = data.enabled ? 'Enabled' : 'Disabled';
            var borderColor = type === 'seo' ? 'border-l-purple-500' : (type === 'voice' ? 'border-l-green-500' : 'border-l-orange-500');

            // Badge for LLM-powered rules
            var llmBadge = '';
            if (data.prompt) {
                llmBadge = '<span class="px-2 py-1 text-xs rounded-full bg-purple-500/20 text-purple-400">AI-Powered</span>';
            }

            // Severity badge for SEO rules
            var severityBadge = '';
            if (data.severity) {
                var severityClass = {
                    'Critical': 'bg-red-500/20 text-red-400',
                    'High': 'bg-orange-500/20 text-orange-400',
                    'Medium': 'bg-yellow-500/20 text-yellow-400',
                    'Low': 'bg-blue-500/20 text-blue-400'
                }[data.severity] || 'bg-gray-500/20 text-gray-400';
                severityBadge = '<span class="px-2 py-1 text-xs rounded-full ' + severityClass + '">' + data.severity + '</span>';
            }

            // System rules can't be deleted, only edited
            var deleteButton = data.system
                ? '<span class="text-gray-600 p-2 cursor-not-allowed" title="System rules cannot be deleted"></span>'
                : '<button onclick="deleteRule(\'' + type + '\', \'' + id + '\')" class="text-red-400 hover:bg-red-500/10 p-2 rounded transition">Delete</button>';

            var systemBadge = data.system
                ? '<span class="px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-400">System</span>'
                : '';

            return '<div class="card rounded-lg p-4 ' + borderColor + ' border-l-4 hover:bg-card-hover transition-all">' +
                '<div class="flex justify-between items-start">' +
                    '<div class="flex-1">' +
                        '<div class="flex items-center gap-2 mb-2 flex-wrap">' +
                            '<h3 class="font-semibold text-primary">' + escapeHtml(data.name) + '</h3>' +
                            '<span class="px-2 py-1 text-xs rounded-full ' + statusClass + '">' + statusText + '</span>' +
                            severityBadge +
                            llmBadge +
                            systemBadge +
                        '</div>' +
                        '<p class="text-secondary text-sm">' + escapeHtml(data.description) + '</p>' +
                    '</div>' +
                    '<div class="flex gap-2 ml-4">' +
                        '<button onclick="editRule(\'' + type + '\', \'' + id + '\')" class="text-accent hover:bg-card-hover p-2 rounded transition">Edit</button>' +
                        deleteButton +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function openModal(title, collection) {
            currentCollection = collection;
            currentEditId = null;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('formName').value = '';
            document.getElementById('formDescription').value = '';
            document.getElementById('formEnabled').checked = true;
            document.getElementById('extraFields').innerHTML = '';
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            currentEditId = null;
            currentCollection = null;
        }

        // Add functions
        function addSeoRule() {
            openModal('Add SEO/GEO Rule', 'seoRules');
            document.getElementById('extraFields').innerHTML =
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">Severity</label>' +
                    '<select id="formSeverity" class="w-full input-dark border rounded-lg px-3 py-2">' +
                        '<option value="Critical">Critical</option>' +
                        '<option value="High">High</option>' +
                        '<option value="Medium" selected>Medium</option>' +
                        '<option value="Low">Low</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">What should this rule check? <span class="text-red-400">*</span></label>' +
                    '<textarea id="formUserDescription" rows="3" class="w-full input-dark border rounded-lg px-3 py-2 text-sm" placeholder="Describe in plain English what you want to check. Example: Make sure all prices on the page are displayed in USD format with dollar signs."></textarea>' +
                    '<button type="button" onclick="generatePrompt()" class="mt-2 px-4 py-2 bg-purple-500/20 border border-purple-500 text-purple-400 rounded-lg text-sm hover:bg-purple-500/30 transition flex items-center gap-2">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
                        'Generate AI Prompt' +
                    '</button>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">LLM Audit Prompt <span class="text-red-400">*</span></label>' +
                    '<textarea id="formPrompt" rows="8" class="w-full input-dark border rounded-lg px-3 py-2 font-mono text-sm" required placeholder="Click \'Generate AI Prompt\' above, or write your own prompt.\n\nThe prompt should specify when the rule PASSES and when it FAILS."></textarea>' +
                    '<p class="text-xs text-secondary mt-1">Claude AI will evaluate pages against this prompt. Generated prompts can be edited before saving.</p>' +
                '</div>' +
                '<input type="hidden" id="formCheckType" value="custom">';
        }

        function addVoiceRule() {
            openModal('Add Voice Guideline', 'voiceRules');
            document.getElementById('extraFields').innerHTML =
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">Category</label>' +
                    '<select id="formCategory" class="w-full input-dark border rounded-lg px-3 py-2">' +
                        '<option value="tone">Tone of Voice</option>' +
                        '<option value="language">Language Style</option>' +
                        '<option value="audience">Target Audience</option>' +
                        '<option value="messaging">Key Messaging</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">Severity</label>' +
                    '<select id="formSeverity" class="w-full input-dark border rounded-lg px-3 py-2">' +
                        '<option value="Critical">Critical</option>' +
                        '<option value="High">High</option>' +
                        '<option value="Medium" selected>Medium</option>' +
                        '<option value="Low">Low</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">What should this rule check? <span class="text-red-400">*</span></label>' +
                    '<textarea id="formUserDescription" rows="3" class="w-full input-dark border rounded-lg px-3 py-2 text-sm" placeholder="Describe in plain English what voice/tone aspect you want to check. Example: Make sure the content sounds friendly and welcoming, not corporate or cold."></textarea>' +
                    '<button type="button" onclick="generatePrompt()" class="mt-2 px-4 py-2 bg-purple-500/20 border border-purple-500 text-purple-400 rounded-lg text-sm hover:bg-purple-500/30 transition flex items-center gap-2">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
                        'Generate AI Prompt' +
                    '</button>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">LLM Audit Prompt <span class="text-red-400">*</span></label>' +
                    '<textarea id="formPrompt" rows="8" class="w-full input-dark border rounded-lg px-3 py-2 font-mono text-sm" required placeholder="Click \'Generate AI Prompt\' above, or write your own prompt.\n\nThe prompt should specify when the rule PASSES and when it FAILS."></textarea>' +
                    '<p class="text-xs text-secondary mt-1">Claude AI will evaluate pages against this prompt. Generated prompts can be edited before saving.</p>' +
                '</div>';
        }

        function addBrandStandard() {
            openModal('Add Brand Standard', 'brandStandards');
            document.getElementById('extraFields').innerHTML =
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">Standard Type</label>' +
                    '<select id="formStandardType" class="w-full input-dark border rounded-lg px-3 py-2">' +
                        '<option value="visual">Visual Identity</option>' +
                        '<option value="terminology">Terminology</option>' +
                        '<option value="compliance">Compliance</option>' +
                        '<option value="accessibility">Accessibility</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">Severity</label>' +
                    '<select id="formSeverity" class="w-full input-dark border rounded-lg px-3 py-2">' +
                        '<option value="Critical">Critical</option>' +
                        '<option value="High">High</option>' +
                        '<option value="Medium" selected>Medium</option>' +
                        '<option value="Low">Low</option>' +
                    '</select>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">What should this rule check? <span class="text-red-400">*</span></label>' +
                    '<textarea id="formUserDescription" rows="3" class="w-full input-dark border rounded-lg px-3 py-2 text-sm" placeholder="Describe in plain English what brand standard you want to check. Example: Make sure the brand name is always capitalized correctly as Outrigger, not OUTRIGGER or outrigger."></textarea>' +
                    '<button type="button" onclick="generatePrompt()" class="mt-2 px-4 py-2 bg-purple-500/20 border border-purple-500 text-purple-400 rounded-lg text-sm hover:bg-purple-500/30 transition flex items-center gap-2">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
                        'Generate AI Prompt' +
                    '</button>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<label class="block text-sm font-medium text-secondary mb-1">LLM Audit Prompt <span class="text-red-400">*</span></label>' +
                    '<textarea id="formPrompt" rows="8" class="w-full input-dark border rounded-lg px-3 py-2 font-mono text-sm" required placeholder="Click \'Generate AI Prompt\' above, or write your own prompt.\n\nThe prompt should specify when the rule PASSES and when it FAILS."></textarea>' +
                    '<p class="text-xs text-secondary mt-1">Claude AI will evaluate pages against this prompt. Generated prompts can be edited before saving.</p>' +
                '</div>';
        }

        // Edit rule (site-specific)
        function editRule(type, id) {
            var collectionName = type === 'seo' ? 'seoRules' : (type === 'voice' ? 'voiceRules' : 'brandStandards');
            currentCollection = collectionName;
            currentEditId = id;

            getSiteCollection(collectionName).doc(id).get()
                .then(function(doc) {
                    if (doc.exists) {
                        var data = doc.data();
                        document.getElementById('modalTitle').textContent = 'Edit ' + data.name;
                        document.getElementById('formName').value = data.name || '';
                        document.getElementById('formDescription').value = data.description || '';
                        document.getElementById('formEnabled').checked = data.enabled !== false;

                        // Build extra fields based on type
                        if (type === 'seo') {
                            document.getElementById('extraFields').innerHTML =
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-secondary mb-1">Check Type</label>' +
                                    '<select id="formCheckType" class="w-full input-dark border rounded-lg px-3 py-2">' +
                                        '<option value="title"' + (data.checkType === 'title' ? ' selected' : '') + '>Title Tag</option>' +
                                        '<option value="meta"' + (data.checkType === 'meta' ? ' selected' : '') + '>Meta Description</option>' +
                                        '<option value="h1"' + (data.checkType === 'h1' ? ' selected' : '') + '>H1 Heading</option>' +
                                        '<option value="canonical"' + (data.checkType === 'canonical' ? ' selected' : '') + '>Canonical Tag</option>' +
                                        '<option value="schema"' + (data.checkType === 'schema' ? ' selected' : '') + '>Schema/Structured Data</option>' +
                                        '<option value="content"' + (data.checkType === 'content' ? ' selected' : '') + '>Content Quality</option>' +
                                        '<option value="geo"' + (data.checkType === 'geo' ? ' selected' : '') + '>Geo Meta Tags</option>' +
                                        '<option value="og"' + (data.checkType === 'og' ? ' selected' : '') + '>Open Graph Tags</option>' +
                                        '<option value="alt"' + (data.checkType === 'alt' ? ' selected' : '') + '>Image Alt Tags</option>' +
                                        '<option value="robots"' + (data.checkType === 'robots' ? ' selected' : '') + '>Robots Meta Tag</option>' +
                                        '<option value="custom"' + (data.checkType === 'custom' ? ' selected' : '') + '>Custom (LLM-only)</option>' +
                                    '</select>' +
                                '</div>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-secondary mb-1">Severity</label>' +
                                    '<select id="formSeverity" class="w-full input-dark border rounded-lg px-3 py-2">' +
                                        '<option value="Critical"' + (data.severity === 'Critical' ? ' selected' : '') + '>Critical</option>' +
                                        '<option value="High"' + (data.severity === 'High' ? ' selected' : '') + '>High</option>' +
                                        '<option value="Medium"' + (data.severity === 'Medium' || !data.severity ? ' selected' : '') + '>Medium</option>' +
                                        '<option value="Low"' + (data.severity === 'Low' ? ' selected' : '') + '>Low</option>' +
                                    '</select>' +
                                '</div>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-secondary mb-1">LLM Audit Prompt <span class="text-secondary/60 font-normal">(optional)</span></label>' +
                                    '<textarea id="formPrompt" rows="6" class="w-full input-dark border rounded-lg px-3 py-2 font-mono text-sm">' + escapeHtml(data.prompt || '') + '</textarea>' +
                                    '<p class="text-xs text-secondary mt-1">When a prompt is provided, Claude AI will evaluate the page against this rule dynamically.</p>' +
                                '</div>';
                        } else {
                            // Voice & Brand rules - show severity and prompt fields for LLM evaluation
                            document.getElementById('extraFields').innerHTML =
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-secondary mb-1">Severity</label>' +
                                    '<select id="formSeverity" class="w-full input-dark border rounded-lg px-3 py-2">' +
                                        '<option value="Critical"' + (data.severity === 'Critical' ? ' selected' : '') + '>Critical</option>' +
                                        '<option value="High"' + (data.severity === 'High' ? ' selected' : '') + '>High</option>' +
                                        '<option value="Medium"' + (data.severity === 'Medium' || !data.severity ? ' selected' : '') + '>Medium</option>' +
                                        '<option value="Low"' + (data.severity === 'Low' ? ' selected' : '') + '>Low</option>' +
                                    '</select>' +
                                '</div>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-sm font-medium text-secondary mb-1">LLM Audit Prompt <span class="text-red-400">*</span></label>' +
                                    '<textarea id="formPrompt" rows="6" class="w-full input-dark border rounded-lg px-3 py-2 font-mono text-sm" required>' + escapeHtml(data.prompt || '') + '</textarea>' +
                                    '<p class="text-xs text-secondary mt-1">Claude AI will evaluate the page content against this prompt. Be specific about what to check.</p>' +
                                '</div>';
                        }

                        document.getElementById('modal').classList.remove('hidden');
                        document.getElementById('modal').classList.add('flex');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading rule:', error);
                    showToast('Error loading rule for editing', 'error');
                });
        }

        // Generate LLM prompt from user description using Claude
        async function generatePrompt() {
            var userDescription = document.getElementById('formUserDescription');
            if (!userDescription) {
                showToast('User description field not found', 'error');
                return;
            }

            var description = userDescription.value.trim();
            if (!description) {
                showToast('Please describe what the rule should check', 'warning');
                return;
            }

            var button = event.target.closest('button');
            var originalText = button.innerHTML;
            button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
            button.disabled = true;

            try {
                var response = await fetch('https://outrigger-seo-audit-22338575803.us-central1.run.app?generate_prompt=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description })
                });

                var result = await response.json();

                if (result.prompt) {
                    document.getElementById('formPrompt').value = result.prompt;
                    showToast('Prompt generated! Review and edit as needed.', 'success');
                } else if (result.error) {
                    showToast('Error: ' + result.error, 'error');
                } else {
                    showToast('Failed to generate prompt', 'error');
                }
            } catch (error) {
                console.error('Error generating prompt:', error);
                showToast('Error connecting to server', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Delete rule (site-specific)
        function deleteRule(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            var collectionName = type === 'seo' ? 'seoRules' : (type === 'voice' ? 'voiceRules' : 'brandStandards');

            getSiteCollection(collectionName).doc(id).delete()
                .then(function() {
                    loadAllData();
                })
                .catch(function(error) {
                    console.error('Error deleting:', error);
                    showToast('Error deleting item', 'error');
                });
        }

        // Form submission
        document.getElementById('modalForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var data = {
                name: document.getElementById('formName').value,
                description: document.getElementById('formDescription').value,
                enabled: document.getElementById('formEnabled').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add extra fields based on collection
            var checkType = document.getElementById('formCheckType');
            var category = document.getElementById('formCategory');
            var standardType = document.getElementById('formStandardType');
            var severity = document.getElementById('formSeverity');
            var prompt = document.getElementById('formPrompt');

            if (checkType) data.checkType = checkType.value;
            if (category) data.category = category.value;
            if (standardType) data.standardType = standardType.value;
            if (severity) data.severity = severity.value;
            if (prompt && prompt.value.trim()) {
                data.prompt = prompt.value.trim();
            }

            var savePromise;
            if (currentEditId) {
                savePromise = getSiteCollection(currentCollection).doc(currentEditId).update(data);
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = getSiteCollection(currentCollection).add(data);
            }

            savePromise
                .then(function() {
                    closeModal();
                    loadAllData();
                })
                .catch(function(error) {
                    console.error('Error saving:', error);
                    showToast('Error saving: ' + error.message, 'error');
                });
        });

        // Site modal form submission
        document.getElementById('siteModalForm').addEventListener('submit', saveSite);

        // Load all data
        function loadAllData() {
            loadSeoRules();
            loadVoiceRules();
            loadBrandStandards();
        }

        // Seed default rules (run once to populate)
        // Parameters: which rule types to reseed (all default to true for backward compatibility)
        async function seedDefaultRules(reseedSeo = true, reseedVoice = true, reseedBrand = true) {

            const seoRules = [
                // ============================================
                // LEGACY RULES (code-based only, no LLM)
                // Fast & free - just checks if elements exist
                // ============================================
                {
                    name: 'Title Tag Check',
                    checkType: 'title',
                    description: 'Checks for missing or too-short title tags (under 30 chars).',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1,
                    system: true
                },
                {
                    name: 'Meta Description Check',
                    checkType: 'meta',
                    description: 'Checks for missing or too-short meta descriptions (under 120 chars).',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1,
                    system: true
                },
                {
                    name: 'H1 Tag Check',
                    checkType: 'h1',
                    description: 'Checks for missing H1 or multiple H1 tags.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1,
                    system: true
                },
                {
                    name: 'Canonical Tag Check',
                    checkType: 'canonical',
                    description: 'Checks for missing canonical URL tag.',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1,
                    system: true
                },
                {
                    name: 'Schema/Structured Data Check',
                    checkType: 'schema',
                    description: 'Checks for presence of JSON-LD structured data.',
                    enabled: true,
                    severity: 'High',
                    tier: 2,
                    system: true
                },
                {
                    name: 'Thin Content Check',
                    checkType: 'content',
                    description: 'Flags pages with less than 300 words of content.',
                    enabled: true,
                    severity: 'High',
                    tier: 2,
                    system: true
                },
                {
                    name: 'Geo Meta Tags Check',
                    checkType: 'geo',
                    description: 'Checks for geo.region and geo.placename meta tags.',
                    enabled: true,
                    severity: 'High',
                    tier: 2,
                    system: true
                },
                {
                    name: 'Open Graph Tags Check',
                    checkType: 'og',
                    description: 'Checks for og:image, og:title, og:description tags.',
                    enabled: true,
                    severity: 'High',
                    tier: 2,
                    system: true
                },
                {
                    name: 'Image Alt Tags Check',
                    checkType: 'alt',
                    description: 'Checks for missing alt text on images.',
                    enabled: true,
                    severity: 'Medium',
                    tier: 3,
                    system: true
                },
                {
                    name: 'Robots Meta Tag Check',
                    checkType: 'robots',
                    description: 'Checks for presence of robots meta tag.',
                    enabled: false,
                    severity: 'Low',
                    tier: 3,
                    system: true
                },
                // ============================================
                // LLM RULES (AI-powered, require prompt)
                // These analyze content quality & relevance
                // ============================================
                {
                    name: 'Meta Content Relevance Check',
                    checkType: 'meta_relevance',
                    description: 'AI checks that meta tags accurately describe THIS page (catches copy-paste errors).',
                    prompt: 'Check if the meta tags accurately describe THIS specific page. The rule FAILS if:\n1. The meta description mentions a DIFFERENT property/resort than the page is about, OR\n2. The og:description mentions a different location than the page URL indicates, OR\n3. The title tag references a different property than the page content, OR\n4. Meta content appears to be copy-pasted from another page (wrong property name, wrong location)\n\nIMPORTANT: Compare the URL path and H1/main content against the meta tags.\nExample FAIL: Page URL is "/kona-resort-spa" but meta description says "Waikiki Beach"',
                    enabled: true,
                    severity: 'Critical',
                    tier: 1,
                    system: true
                },
            ];

            // Voice rules - examples only, NOT system rules (can be deleted/customized per site)
            const voiceRules = [
                {
                    name: 'Warm & Welcoming Tone',
                    category: 'tone',
                    description: 'Example: Content should convey warmth and hospitality. Customize this for your brand voice.',
                    prompt: 'Analyze the tone and voice of this page content. The rule FAILS if:\n1. The content feels cold, corporate, or impersonal\n2. There is excessive use of business jargon or formal language\n3. The writing lacks warmth or a welcoming feel\n\nLook for: friendly greetings, personal pronouns (you, your, we), inviting language, and genuine hospitality expressions.',
                    severity: 'Medium',
                    enabled: true
                },
                {
                    name: 'Engaging & Inspiring',
                    category: 'tone',
                    description: 'Example: Content should inspire and engage readers. Customize this for your brand voice.',
                    prompt: 'Check if the content is engaging and inspiring. The rule FAILS if:\n1. The content is purely transactional without any inspiring language\n2. The writing is bland and doesnt evoke excitement or curiosity\n3. There is no emotional connection with the reader\n\nLook for: action words, experiential language, and content that makes readers want to learn more.',
                    severity: 'Low',
                    enabled: true
                },
            ];

            // Brand standards - examples only, NOT system rules (can be deleted/customized per site)
            const brandStandards = [
                {
                    name: 'Brand Name Consistency',
                    standardType: 'terminology',
                    description: 'Example: Ensure brand name is used consistently. Customize this with your brand guidelines.',
                    prompt: 'Check brand name usage consistency. The rule FAILS if:\n1. The brand name is written inconsistently (different capitalizations, spellings, or variations)\n2. The brand is referred to incorrectly\n\nNote: Customize this prompt with your specific brand name and approved variations.',
                    severity: 'High',
                    enabled: true
                },
                {
                    name: 'Call-to-Action Presence',
                    standardType: 'compliance',
                    description: 'Example: Pages should have clear calls-to-action. Customize based on your conversion goals.',
                    prompt: 'Check for clear calls-to-action. The rule FAILS if:\n1. A marketing or key landing page has no visible call-to-action\n2. CTAs are buried or unclear\n\nLook for: action buttons or links that guide users to the next step.',
                    severity: 'Medium',
                    enabled: true
                },
            ];

            let added = 0;
            let deleted = 0;

            // Check if site is selected
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }

            // Delete and reseed only selected rule types
            console.log('Reseeding rules...', { reseedSeo, reseedVoice, reseedBrand });

            // SEO Rules
            if (reseedSeo) {
                const snapshot = await getSiteCollection('seoRules').get();
                const batch = db.batch();
                snapshot.forEach(doc => batch.delete(doc.ref));
                if (!snapshot.empty) {
                    await batch.commit();
                    deleted += snapshot.size;
                    console.log(`Deleted ${snapshot.size} seoRules`);
                }
                for (const rule of seoRules) {
                    await getSiteCollection('seoRules').add({ ...rule, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                }
            }

            // Voice Rules
            if (reseedVoice) {
                const snapshot = await getSiteCollection('voiceRules').get();
                const batch = db.batch();
                snapshot.forEach(doc => batch.delete(doc.ref));
                if (!snapshot.empty) {
                    await batch.commit();
                    deleted += snapshot.size;
                    console.log(`Deleted ${snapshot.size} voiceRules`);
                }
                for (const rule of voiceRules) {
                    await getSiteCollection('voiceRules').add({ ...rule, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                }
            }

            // Brand Standards
            if (reseedBrand) {
                const snapshot = await getSiteCollection('brandStandards').get();
                const batch = db.batch();
                snapshot.forEach(doc => batch.delete(doc.ref));
                if (!snapshot.empty) {
                    await batch.commit();
                    deleted += snapshot.size;
                    console.log(`Deleted ${snapshot.size} brandStandards`);
                }
                for (const standard of brandStandards) {
                    await getSiteCollection('brandStandards').add({ ...standard, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    added++;
                }
            }

            var types = [];
            if (reseedSeo) types.push('SEO');
            if (reseedVoice) types.push('Voice');
            if (reseedBrand) types.push('Brand');
            showToast('Reset ' + types.join(', ') + ' rules (' + added + ' added)', 'success');
            loadAllData();
        }

        // ============ SETTINGS FUNCTIONS ============

        // Load settings from Firestore
        function loadSettings() {
            // Update Firestore connection status
            updateFirestoreStatus();

            // Load saved settings from site-specific config
            if (!currentSiteId) {
                console.log('No site selected, cannot load settings');
                document.getElementById('displaySiteId').textContent = '-';
                document.getElementById('displaySiteName').textContent = '-';
                return;
            }

            // Display Site ID
            document.getElementById('displaySiteId').textContent = currentSiteId;

            db.collection('sites').doc(currentSiteId).collection('config').doc('settings').get()
                .then(function(doc) {
                    if (doc.exists) {
                        var settings = doc.data();
                        // Display Site Name
                        document.getElementById('displaySiteName').textContent = settings.name || currentSiteId;
                        if (settings.sitemapUrl) document.getElementById('configSitemapUrl').value = settings.sitemapUrl;
                        if (settings.daysToCheck) document.getElementById('configDaysToCheck').value = settings.daysToCheck;
                        if (settings.maxPages !== undefined) document.getElementById('configMaxPages').value = settings.maxPages;
                        if (settings.aiModel) document.getElementById('configAiModel').value = settings.aiModel;
                        if (settings.rulesPerBatch) document.getElementById('configRulesPerBatch').value = settings.rulesPerBatch;
                        if (settings.enableLLM !== undefined) document.getElementById('configEnableLLM').checked = settings.enableLLM;
                        // Load schedule configuration
                        loadScheduleConfig(settings.schedule);
                    } else {
                        document.getElementById('displaySiteName').textContent = currentSiteId;
                        // Clear form if no settings exist for this site
                        document.getElementById('configSitemapUrl').value = '';
                        document.getElementById('configDaysToCheck').value = '7';
                        document.getElementById('configMaxPages').value = '10';
                        document.getElementById('configAiModel').value = 'claude-sonnet-4-20250514';
                        document.getElementById('configRulesPerBatch').value = '5';
                        document.getElementById('configEnableLLM').checked = true;
                        // Reset schedule to disabled
                        loadScheduleConfig(null);
                    }
                })
                .catch(function(error) {
                    console.log('No saved settings found, using defaults');
                    loadScheduleConfig(null);
                });
        }

        // Update Firestore status indicator
        function updateFirestoreStatus() {
            var statusEl = document.getElementById('firestoreStatus');
            db.collection('seoRules').limit(1).get()
                .then(function() {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span><span class="text-green-400 text-sm">Connected</span>';
                })
                .catch(function() {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span><span class="text-red-400 text-sm">Error</span>';
                });
        }

        // ============ SCHEDULER FUNCTIONS ============

        // Toggle schedule options visibility
        function toggleScheduleOptions() {
            var enabled = document.getElementById('scheduleEnabled').checked;
            var options = document.getElementById('scheduleOptions');
            var badge = document.getElementById('scheduleStatusBadge');

            if (enabled) {
                options.classList.remove('hidden');
                badge.textContent = 'Active';
                badge.className = 'px-2 py-1 text-xs rounded-full bg-cyan-500/20 text-cyan-400';
            } else {
                options.classList.add('hidden');
                badge.textContent = 'Disabled';
                badge.className = 'px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-400';
            }
            updateScheduleSummary();
        }

        // Update schedule UI when frequency changes
        function updateScheduleUI() {
            var frequency = document.querySelector('input[name="scheduleFrequency"]:checked').value;
            var weeklySelect = document.getElementById('weeklyDaySelect');
            var monthlySelect = document.getElementById('monthlyDaySelect');

            if (frequency === 'daily') {
                weeklySelect.classList.add('hidden');
                monthlySelect.classList.add('hidden');
            } else if (frequency === 'weekly') {
                weeklySelect.classList.remove('hidden');
                monthlySelect.classList.add('hidden');
            } else if (frequency === 'monthly') {
                weeklySelect.classList.add('hidden');
                monthlySelect.classList.remove('hidden');
            }
            updateScheduleSummary();
        }

        // Toggle date range inputs
        function toggleDateRangeInputs() {
            var rangeMode = document.querySelector('input[name="scheduleDateRange"]:checked').value;
            var inputs = document.getElementById('dateRangeInputs');

            if (rangeMode === 'range') {
                inputs.classList.remove('hidden');
                // Set default dates if empty
                var startInput = document.getElementById('scheduleStartDate');
                var endInput = document.getElementById('scheduleEndDate');
                if (!startInput.value) {
                    var today = new Date();
                    startInput.value = today.toISOString().split('T')[0];
                }
                if (!endInput.value) {
                    var threeMonths = new Date();
                    threeMonths.setMonth(threeMonths.getMonth() + 3);
                    endInput.value = threeMonths.toISOString().split('T')[0];
                }
            } else {
                inputs.classList.add('hidden');
            }
            updateScheduleSummary();
        }

        // Update schedule summary text
        function updateScheduleSummary() {
            var frequency = document.querySelector('input[name="scheduleFrequency"]:checked').value;
            var hour = document.getElementById('scheduleHour').value;
            var rangeMode = document.querySelector('input[name="scheduleDateRange"]:checked').value;

            var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var summary = 'Audits will run ';

            if (frequency === 'daily') {
                summary += 'every day';
            } else if (frequency === 'weekly') {
                var dayOfWeek = document.getElementById('scheduleDayOfWeek').value;
                summary += 'every ' + dayNames[parseInt(dayOfWeek)];
            } else if (frequency === 'monthly') {
                var dayOfMonth = document.getElementById('scheduleDayOfMonth').value;
                if (dayOfMonth === 'last') {
                    summary += 'on the last day of each month';
                } else {
                    var suffix = 'th';
                    if (dayOfMonth === '1' || dayOfMonth === '21') suffix = 'st';
                    else if (dayOfMonth === '2') suffix = 'nd';
                    else if (dayOfMonth === '3') suffix = 'rd';
                    summary += 'on the ' + dayOfMonth + suffix + ' of each month';
                }
            }

            summary += ' at ' + hour.padStart(2, '0') + ':00 UTC';

            if (rangeMode === 'range') {
                var startDate = document.getElementById('scheduleStartDate').value;
                var endDate = document.getElementById('scheduleEndDate').value;
                if (startDate && endDate) {
                    summary += ' (from ' + startDate + ' to ' + endDate + ')';
                }
            }

            document.getElementById('scheduleSummary').textContent = summary;
        }

        // Get schedule configuration from UI
        function getScheduleConfig() {
            var enabled = document.getElementById('scheduleEnabled').checked;
            if (!enabled) {
                return { enabled: false };
            }

            var frequency = document.querySelector('input[name="scheduleFrequency"]:checked').value;
            var hour = parseInt(document.getElementById('scheduleHour').value);
            var rangeMode = document.querySelector('input[name="scheduleDateRange"]:checked').value;

            var config = {
                enabled: true,
                frequency: frequency,
                hour: hour,
                auditTypes: {
                    seo: document.getElementById('scheduleSeo').checked,
                    voice: document.getElementById('scheduleVoice').checked,
                    brand: document.getElementById('scheduleBrand').checked
                }
            };

            if (frequency === 'weekly') {
                config.dayOfWeek = parseInt(document.getElementById('scheduleDayOfWeek').value);
            } else if (frequency === 'monthly') {
                config.dayOfMonth = document.getElementById('scheduleDayOfMonth').value;
            }

            if (rangeMode === 'range') {
                config.startDate = document.getElementById('scheduleStartDate').value;
                config.endDate = document.getElementById('scheduleEndDate').value;
            }

            return config;
        }

        // Load schedule configuration into UI
        function loadScheduleConfig(schedule) {
            if (!schedule) {
                document.getElementById('scheduleEnabled').checked = false;
                toggleScheduleOptions();
                return;
            }

            document.getElementById('scheduleEnabled').checked = schedule.enabled || false;

            if (schedule.frequency) {
                var freqRadio = document.querySelector('input[name="scheduleFrequency"][value="' + schedule.frequency + '"]');
                if (freqRadio) freqRadio.checked = true;
            }

            if (schedule.dayOfWeek !== undefined) {
                document.getElementById('scheduleDayOfWeek').value = schedule.dayOfWeek;
            }

            if (schedule.dayOfMonth) {
                document.getElementById('scheduleDayOfMonth').value = schedule.dayOfMonth;
            }

            if (schedule.hour !== undefined) {
                document.getElementById('scheduleHour').value = schedule.hour;
            }

            if (schedule.startDate && schedule.endDate) {
                document.querySelector('input[name="scheduleDateRange"][value="range"]').checked = true;
                document.getElementById('scheduleStartDate').value = schedule.startDate;
                document.getElementById('scheduleEndDate').value = schedule.endDate;
            } else {
                document.querySelector('input[name="scheduleDateRange"][value="always"]').checked = true;
            }

            if (schedule.auditTypes) {
                document.getElementById('scheduleSeo').checked = schedule.auditTypes.seo !== false;
                document.getElementById('scheduleVoice').checked = schedule.auditTypes.voice !== false;
                document.getElementById('scheduleBrand').checked = schedule.auditTypes.brand !== false;
            }

            toggleScheduleOptions();
            updateScheduleUI();
            toggleDateRangeInputs();
        }

        // Save settings to Firestore (site-specific)
        function saveSettings() {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }

            var scheduleConfig = getScheduleConfig();

            var settings = {
                sitemapUrl: document.getElementById('configSitemapUrl').value,
                daysToCheck: parseInt(document.getElementById('configDaysToCheck').value) || 7,
                maxPages: parseInt(document.getElementById('configMaxPages').value) || 0,
                aiModel: document.getElementById('configAiModel').value,
                rulesPerBatch: parseInt(document.getElementById('configRulesPerBatch').value) || 5,
                enableLLM: document.getElementById('configEnableLLM').checked,
                schedule: scheduleConfig,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('sites').doc(currentSiteId).collection('config').doc('settings').set(settings, { merge: true })
                .then(function() {
                    showToast('Settings saved successfully!', 'success');
                    // If schedule is enabled, sync with Cloud Scheduler
                    if (scheduleConfig.enabled) {
                        syncCloudScheduler(currentSiteId, scheduleConfig);
                    }
                })
                .catch(function(error) {
                    console.error('Error saving settings:', error);
                    showToast('Error saving settings: ' + error.message, 'error');
                });
        }

        // Sync schedule configuration with Google Cloud Scheduler
        function syncCloudScheduler(siteId, scheduleConfig) {
            // This will call a Cloud Function to update Google Cloud Scheduler
            // For now, we'll store the config and a Cloud Function can read it
            console.log('Schedule config saved for site:', siteId, scheduleConfig);
            showToast('Schedule configuration saved. Cloud Scheduler will be updated.', 'info');
        }

        // Test sitemap URL
        function testSitemapUrl() {
            var url = document.getElementById('configSitemapUrl').value;
            if (!url) {
                showToast('Please enter a sitemap URL', 'warning');
                return;
            }

            // Open sitemap in new tab for manual verification
            window.open(url, '_blank');
            showToast('Sitemap opened in new tab', 'info');
        }

        // Confirm clear logs
        function confirmClearLogs() {
            showConfirm('Delete All Logs', 'This will permanently delete ALL audit logs. This cannot be undone!', function() {
                // Get all audit logs and delete them
                getSiteCollection('auditLogs').get()
                    .then(function(snapshot) {
                        var batch = db.batch();
                        snapshot.forEach(function(doc) {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(function() {
                        showToast('All audit logs have been deleted', 'success');
                        loadAuditLogs();
                    })
                    .catch(function(error) {
                        console.error('Error deleting logs:', error);
                        showToast('Error deleting logs: ' + error.message, 'error');
                    });
            }, 'danger');
        }

        // Show reseed modal with options
        function confirmResetRules() {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }
            var modal = document.getElementById('reseedModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close reseed modal
        function closeReseedModal() {
            var modal = document.getElementById('reseedModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Execute reseed with selected options
        function executeReseed() {
            var reseedSeo = document.getElementById('reseedSeo').checked;
            var reseedVoice = document.getElementById('reseedVoice').checked;
            var reseedBrand = document.getElementById('reseedBrand').checked;

            if (!reseedSeo && !reseedVoice && !reseedBrand) {
                showToast('Please select at least one rule type', 'warning');
                return;
            }

            closeReseedModal();
            seedDefaultRules(reseedSeo, reseedVoice, reseedBrand);
        }

        // Confirm delete site
        function confirmDeleteSite() {
            if (!currentSiteId) {
                showToast('Please select a site first', 'warning');
                return;
            }

            var siteName = document.getElementById('siteSelector').options[document.getElementById('siteSelector').selectedIndex].text;

            showConfirm('Delete Site', 'This will permanently delete "' + siteName + '" and all its data (logs, rules, settings). This cannot be undone!', function() {
                deleteSite(currentSiteId, siteName);
            }, 'danger');
        }

        // Delete site and all its data
        function deleteSite(siteId, siteName) {
            var statusEl = document.createElement('div');
            statusEl.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            statusEl.innerHTML = '<div class="card rounded-xl p-8 text-center"><div class="animate-spin w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-primary">Deleting site data...</p><p id="deleteStatus" class="text-secondary text-sm mt-2">Preparing...</p></div>';
            document.body.appendChild(statusEl);

            var updateStatus = function(msg) {
                document.getElementById('deleteStatus').textContent = msg;
            };

            // Delete subcollections: auditLogs, auditProgress, config, seoRules, voiceRules, brandStandards
            var subcollections = ['auditLogs', 'auditProgress', 'config', 'seoRules', 'voiceRules', 'brandStandards'];
            var deletePromises = [];

            subcollections.forEach(function(subcollection) {
                var promise = db.collection('sites').doc(siteId).collection(subcollection).get()
                    .then(function(snapshot) {
                        updateStatus('Deleting ' + subcollection + ' (' + snapshot.size + ' documents)...');
                        if (snapshot.empty) {
                            return Promise.resolve(); // Nothing to delete
                        }
                        var batch = db.batch();
                        snapshot.forEach(function(doc) {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    });
                deletePromises.push(promise);
            });

            Promise.all(deletePromises)
                .then(function() {
                    updateStatus('Deleting site document...');
                    return db.collection('sites').doc(siteId).delete();
                })
                .then(function() {
                    document.body.removeChild(statusEl);
                    showToast('Site "' + siteName + '" has been permanently deleted', 'success');

                    // Reset to no site selected and reload sites list
                    currentSiteId = null;
                    loadSites();
                    showTab('dashboard');
                })
                .catch(function(error) {
                    document.body.removeChild(statusEl);
                    console.error('Error deleting site:', error);
                    showToast('Error deleting site: ' + error.message, 'error');
                });
        }

        // Note: Initialization is handled by the authentication code at the top of this script
    </script>
</body>
</html>
